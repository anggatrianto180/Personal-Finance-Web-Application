<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Finance Tracker</title>
    <!-- Ganti dengan logo Anda: pastikan file LogoAT.png ada di folder yang sama -->
    <link rel="icon" href="LogoAT.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            /* allow child content (trend/chart wrappers) to define height so they push content down */
            height: auto;
            min-height: 0;
            padding-bottom: 0;
        }
        /* Trend canvas wrapper: fixed visual height but not absolute so it participates in layout */
        #trend-canvas-wrapper > div { height: 360px; width: 100%; position: relative; }
        #trend-canvas-wrapper canvas, #distribution-canvas-wrapper canvas { width: 100% !important; height: 100% !important; display: block; position: relative; }
        /* ensure budget block is below charts */
        #budget-status { margin-top: 1rem; position: relative; z-index: 2; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            cursor: pointer;
        }
        .filter-btn-active {
            background-color: #2563eb !important;
            color: white !important;
        }
        /* Toast: center on small screens, keep bottom-right on desktop */
        #toast-container { right: 1rem; left: auto; }
        @media (max-width: 640px) {
            #toast-container { left: 50%; transform: translateX(-50%); right: auto; bottom: 1rem; width: calc(100% - 2rem); max-width: 420px; }
            #toast-container > .toast { width: 100%; box-sizing: border-box; }
        }

        /* Modals and large panels: ensure they fit on mobile and scroll internally */
        #modal section, #mobile-form-container, #change-password-modal > div, #forgot-email-modal > div, #auth-modal > div, #password-modal > div, #confirm-modal > div {
            max-height: 90vh;
            overflow: auto;
        }
    </style>
</head>
<body class="bg-[#F9F5F0] dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Full-page login shown when user is not authenticated -->
    <div id="full-login-page" class="min-h-screen flex items-center justify-center p-6 bg-[#F9F5F0] dark:bg-gray-900">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-100">Please sign in</h2>
            <input id="full-email" type="email" placeholder="Email" class="w-full p-2 border rounded mb-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
            <input id="full-password" type="password" placeholder="Password" class="w-full p-2 border rounded mb-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" />
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button id="full-register-btn" type="button" class="text-sm text-blue-600 hover:underline">Register</button>
                    <button id="full-forgot-btn" type="button" class="text-sm text-blue-600 hover:underline">Forgot password?</button>
                </div>
                <button id="full-login-submit" type="button" aria-label="Sign in" class="px-4 py-2 rounded bg-blue-600 text-white">Login</button>
            </div>
            <div id="full-login-msg" class="text-sm text-red-600 hidden"></div>
        </div>
    </div>

    <div id="app-root" class="container mx-auto p-4 sm:p-6 md:p-8">

    <!-- Toast container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-2"></div>

    <!-- Header (mobile-first): Home left, icons right, Year/Month selects below) -->
    <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
        <div class="w-full flex items-center justify-between flex-wrap">
            <div class="flex items-center">
                <button id="home-btn" type="button" aria-label="Home" class="text-lg font-semibold text-gray-800 dark:text-gray-100">Home</button>
            </div>

            <div class="flex items-center space-x-2">
                <button id="export-btn" type="button" class="p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" aria-label="Export">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                </button>

                <button id="import-btn" type="button" class="p-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400" aria-label="Import" title="Import transactions">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v12m0 0l4-4m-4 4l-4-4M21 21H3"/></svg>
                </button>

                <button id="theme-toggle" type="button" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none" aria-label="Toggle theme">
                    <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>

                <div id="auth-controls" class="flex items-center gap-2">
                    <button id="login-btn" type="button" class="hidden bg-transparent border border-blue-600 text-blue-600 px-3 py-1 rounded-lg text-sm">Login</button>
                    <button id="register-btn" type="button" class="hidden bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">Register</button>
                    <div id="user-info" class="items-center gap-2 relative">
                        <button id="user-menu-btn" type="button" class="ml-2 p-1 rounded-full bg-gray-100 dark:bg-gray-700 hover:opacity-90" aria-label="User menu">
                            <span class="sr-only">Open user menu</span>
                            <div class="h-8 w-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-sm font-medium text-white">U</div>
                        </button>
                        <div id="user-menu" class="hidden absolute right-0 mt-10 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg z-50">
                            <div class="p-3">
                                <div class="text-sm text-gray-600 dark:text-gray-300 truncate" id="user-menu-email"></div>
                                <div class="mt-3">
                                                    <button id="user-menu-change-pw" type="button" class="w-full bg-gray-200 text-gray-800 py-2 rounded text-sm mb-2">Change password</button>
                                                    <button id="user-menu-logout" type="button" class="w-full bg-red-500 text-white py-2 rounded text-sm">Logout</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- selects row: stacks on mobile, inline on desktop -->
        <div class="w-full mt-3 sm:mt-0 sm:w-auto flex flex-col sm:flex-row sm:items-center sm:space-x-2">
            <div class="flex justify-start sm:justify-end w-full sm:w-auto space-x-0 sm:space-x-2">
                <select id="year-select" class="w-full sm:w-40 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm px-4 py-2 h-10 text-sm leading-5 focus:outline-none focus:ring-2 focus:ring-blue-500 transition mb-2 sm:mb-0"></select>
                <select id="month-filter" class="w-full sm:w-40 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm px-4 py-2 h-10 text-sm leading-5 focus:outline-none focus:ring-2 focus:ring-blue-500 transition mb-2 sm:mb-0"></select>
            </div>
        </div>
    </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-2 space-y-8">
                <section id="summary-section" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4 text-gray-600 dark:text-gray-300">Summary</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-center">
                        <div class="bg-green-50 dark:bg-green-900/50 p-4 rounded-lg">
                            <p class="text-sm text-green-700 dark:text-green-300 font-semibold">Income</p>
                            <div class="flex items-center justify-center gap-2">
                                <p id="total-income" class="text-base sm:text-xl font-normal sm:font-bold text-green-800 dark:text-green-200">Rp 0</p>
                                <button id="income-visibility-toggle" type="button" aria-label="Toggle income visibility" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg class="w-6 h-6" id="income-eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    <svg class="w-6 h-6 hidden" id="income-eye-closed" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/50 p-4 rounded-lg">
                            <p class="text-sm text-blue-700 dark:text-blue-300 font-semibold">Balance</p>
                             <div class="flex items-center justify-center gap-2">
                                <p id="net-balance" class="text-base sm:text-xl font-normal sm:font-bold text-blue-800 dark:text-blue-200">Rp 0</p>
                                <button id="balance-visibility-toggle" type="button" aria-label="Toggle balance visibility" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg class="w-6 h-6" id="balance-eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    <svg class="w-6 h-6 hidden" id="balance-eye-closed" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/50 p-4 rounded-lg col-span-2 sm:col-span-1">
                            <p class="text-sm text-red-700 dark:text-red-300 font-semibold">Expenses</p>
                            <p id="total-expense" class="text-lg sm:text-2xl font-normal sm:font-bold text-red-800 dark:text-red-200">Rp 0</p>
                        </div>
                    </div>
                </section>
                <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-2 text-gray-600 dark:text-gray-300">Expense Distribution</h2>
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm text-gray-500 dark:text-gray-400">This chart shows the proportion of your actual expenses for each category.</p>
                        <div id="distribution-total" class="text-sm font-semibold text-gray-700 dark:text-gray-200">Total: Rp 0</div>
                    </div>
                    <div class="chart-container">
                        <div class="mb-3 flex flex-col items-center">
                            <div class="inline-flex rounded-md shadow-sm" role="group">
                                <!-- Use same filter style as transaction history: apply/remove `filter-btn-active` -->
                                <button id="btn-distribution" type="button" class="px-3 py-1 text-sm font-semibold rounded-l-md filter-btn-active" aria-pressed="true">Distribution</button>
                                <button id="btn-trend" type="button" class="px-3 py-1 text-sm font-semibold rounded-r-md" aria-pressed="false">Trend</button>
                            </div>
                            <div id="trend-controls" class="hidden mt-2 flex items-center gap-2">
                                <label class="text-xs text-gray-500 dark:text-gray-400 mr-1">Range:</label>
                                <select id="trend-range" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm">
                                    <option value="6">6 months</option>
                                    <option value="12">12 months</option>
                                </select>
                            </div>
                        </div>
                        <div id="distribution-canvas-wrapper" class="w-full flex justify-center">
                            <canvas id="expense-chart" class="max-w-full"></canvas>
                        </div>
                        <div id="trend-canvas-wrapper" class="w-full hidden" style="max-width:900px;margin-left:auto;margin-right:auto;">
                            <div style="width:100%;height:360px;position:relative;">
                                <canvas id="trend-chart" class="max-w-full" style="position:absolute;left:0;top:0;width:100% !important;height:100% !important;"></canvas>
                            </div>
                        </div>
                        <!-- Analysis cards for Trend -->
                        <div id="trend-analysis-cards" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                            <div id="top-categories-card" class="bg-white dark:bg-gray-800 p-4 rounded-md shadow">
                                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Top Spending Categories (This Year)</h3>
                                <div id="top-categories-list" class="space-y-2"></div>
                            </div>
                            <div id="monthly-compare-card" class="bg-white dark:bg-gray-800 p-4 rounded-md shadow">
                                <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Monthly Spending vs. Last Month</h3>
                                <div class="text-sm text-gray-600 dark:text-gray-300">
                                    <div class="mb-2">This month: <span id="this-month-total" class="font-semibold">Rp 0</span></div>
                                    <div class="mb-2">Last month: <span id="last-month-total" class="font-semibold">Rp 0</span></div>
                                    <div id="month-change" class="font-semibold"></div>
                                </div>
                            </div>
                        </div>
                        <div id="no-expense-message" class="absolute inset-0 flex items-center justify-center text-gray-500 dark:text-gray-400 hidden">
                            No expense data available.
                        </div>
                    </div>
                    <br>
                    <div id="budget-status" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                </section>
                <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                     <div class="flex flex-col justify-between items-start mb-4 gap-4">
                        <h2 class="text-xl font-bold text-gray-600 dark:text-gray-300">Transaction History</h2>
                        <div class="w-full flex flex-col gap-3">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <select id="time-period-filter" class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-semibold h-11 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="month">This Month</option>
                                    <option value="week">This Week</option>
                                    <option value="year">This Year</option>
                                </select>
                                <input id="search-input" type="text" placeholder="Search by description..." class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-sm h-11 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <div>
                                    <div id="type-filter-buttons" class="flex w-full rounded-md bg-gray-200 dark:bg-gray-700 p-1">
                                        <button type="button" data-filter="all" class="filter-btn-active w-full px-3 text-sm font-semibold rounded-md">All</button>
                                        <button type="button" data-filter="Income" class="w-full px-3 text-sm font-semibold rounded-md">Income</button>
                                        <button type="button" data-filter="Expense" class="w-full px-3 text-sm font-semibold rounded-md">Expense</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                     </div>
                    <div class="hidden lg:block overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Account</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="desktop-tbody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                    <div id="mobile-card-list" class="space-y-4 lg:hidden">
                    </div>
                </section>
            </div>

            <div class="hidden lg:block lg:col-span-1">
                <section id="desktop-form-container" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md sticky top-8">
                </section>
            </div>
        </main>
    </div>

    <button id="fab" type="button" aria-label="Add transaction" class="lg:hidden fixed bottom-6 right-6 bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden flex items-center justify-center p-4">
        <section id="mobile-form-container" class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-11/12 max-w-lg mx-auto max-h-[90vh] overflow-y-auto p-6">
        </section>
    </div>
    <!-- hidden file input for import -->
    <input id="import-file-input" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
    <!-- Password modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-lg p-4 max-w-sm w-full border border-gray-200 dark:border-gray-700">
            <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Enter password</h3>
            <input id="password-input" type="password" class="w-full p-2 border rounded mb-3 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Password" />
            <div class="flex justify-end gap-2">
                <button id="password-cancel" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 dark:text-gray-200">Cancel</button>
                <button id="password-submit" type="button" class="px-3 py-1 rounded bg-blue-600 dark:bg-blue-500 text-white">Submit</button>
            </div>
        </div>
    </div>

    <!-- Confirm modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-lg p-4 max-w-sm w-full border border-gray-200 dark:border-gray-700">
            <div id="confirm-text" class="text-sm text-gray-700 dark:text-gray-200 mb-3">Are you sure?</div>
            <div class="flex justify-end gap-2">
                <button id="confirm-cancel" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 dark:text-gray-200">Cancel</button>
                <button id="confirm-ok" type="button" class="px-3 py-1 rounded bg-red-600 dark:bg-red-500 text-white">Delete</button>
            </div>
        </div>
    </div>
    <!-- Change Password modal -->
    <div id="change-password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-lg p-4 max-w-sm w-full border border-gray-200 dark:border-gray-700">
            <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Change Password</h3>
            <input id="current-password" type="password" class="w-full p-2 border rounded mb-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Current password" />
            <input id="new-password" type="password" class="w-full p-2 border rounded mb-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="New password (min 6 chars)" />
            <div class="flex justify-end gap-2">
                <button id="change-pw-cancel" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 dark:text-gray-200">Cancel</button>
                <button id="change-pw-submit" type="button" class="px-3 py-1 rounded bg-blue-600 dark:bg-blue-500 text-white">Change</button>
            </div>
        </div>
    </div>
    <!-- Forgot email modal: ask for email when user forgot their email on login -->
    <div id="forgot-email-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-lg p-4 max-w-sm w-full border border-gray-200 dark:border-gray-700">
            <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Forgot password</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Enter your account email to receive a password reset link.</p>
            <input id="forgot-email-input" type="email" class="w-full p-2 border rounded mb-3 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Your email" />
            <div class="flex justify-end gap-2">
                <button id="forgot-email-cancel" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 dark:text-gray-200">Cancel</button>
                <button id="forgot-email-send" type="button" class="px-3 py-1 rounded bg-blue-600 dark:bg-blue-500 text-white">Send</button>
            </div>
        </div>
    </div>
    <!-- Auth modals: Login & Register -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-900 rounded-lg p-4 max-w-sm w-full border border-gray-200 dark:border-gray-700">
            <h3 id="auth-modal-title" class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Login</h3>
            <input id="auth-email" type="email" class="w-full p-2 border rounded mb-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Email" />
            <input id="auth-password" type="password" class="w-full p-2 border rounded mb-3 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600" placeholder="Password" />
            <div class="text-sm text-right mb-2"><button type="button" id="forgot-password-link" class="text-blue-600 hover:underline">Forgot password?</button></div>
            <div class="flex justify-between items-center">
                <button id="auth-cancel" type="button" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 dark:text-gray-200">Cancel</button>
                <button id="auth-submit" type="button" class="px-3 py-1 rounded bg-blue-600 dark:bg-blue-500 text-white">Submit</button>
            </div>
        </div>
    </div>
    
    <template id="form-template">
        <h2 id="form-title" class="text-xl font-bold mb-6 text-gray-600 dark:text-gray-300">Add Transaction</h2>
        <form id="transaction-form" class="space-y-4">
            <input type="hidden" id="transaction-id">
            <div>
                <label for="date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                <div class="relative mt-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    </div>
                    <input type="date" id="date" class="block w-full pl-12 pr-3 py-2.5 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
            </div>
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                <div class="relative mt-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                    </div>
                    <input type="text" id="description" placeholder="e.g., Lunch" class="block w-full pl-12 pr-3 py-2.5 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
            </div>
            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount</label>
                <div class="relative mt-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-gray-500 sm:text-sm">Rp</span>
                    </div>
                    <input type="text" inputmode="numeric" id="amount" placeholder="25.000" class="block w-full pl-12 pr-3 py-2.5 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                    <div class="relative mt-1">
                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" /></svg>
                        </div>
                        <select id="type" class="block w-full pl-12 pr-3 py-2.5 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"><option>Expense</option><option>Income</option></select>
                    </div>
                </div>
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                    <div class="relative mt-1">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>
                        </div>
                        <select id="category" class="block w-full pl-12 pr-3 py-2.5 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                </div>
            </div>
            <div>
                <label for="account" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Account</label>
                <div class="relative mt-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 21z" /></svg>
                    </div>
                    <select id="account" class="block w-full pl-12 pr-3 py-2.5 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
            </div>
            <div class="flex flex-col space-y-2 pt-4">
                <button type="submit" id="submit-btn" class="w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800 transition">Save</button>
                <button type="button" id="cancel-edit-btn" class="w-full bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2.5 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 dark:focus:ring-offset-gray-800 transition hidden">Cancel</button>
            </div>
            <div class="mt-3 space-y-3">
                <div class="grid grid-cols-1 gap-2">
                    <button type="button" class="toggle-budget-editor w-full bg-gray-100 dark:bg-gray-700 text-base py-2.5 rounded-md">Manage Budgets</button>
                    <button type="button" class="manage-categories-toggle w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-base py-2.5 rounded-md">Manage Categories</button>
                </div>

                <div class="budget-editor mt-3 hidden space-y-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-md">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Set monthly budgets for Expense categories.</p>
                    <div class="budget-fields grid grid-cols-1 gap-2"></div>
                    <div class="flex gap-2 pt-2">
                        <button type="button" class="save-budgets-btn flex-1 bg-blue-600 text-white py-2 rounded-md">Save Budgets</button>
                        <button type="button" class="reset-budgets-btn flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 py-2 rounded-md">Reset</button>
                    </div>
                </div>

                <!-- Manage Categories panel -->
                <div class="categories-panel mt-3 hidden p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md">
                    <h4 class="text-base font-semibold text-gray-800 dark:text-gray-200 mb-3">Manage Categories</h4>
                    <div class="space-y-4">
                        <div class="w-full">
                            <ul class="categories-list divide-y divide-gray-100 dark:divide-gray-700"></ul>
                        </div>
                        <div class="pt-2">
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input class="new-category-name w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 text-sm" type="text" placeholder="New category name" />
                                <select class="new-category-type bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 text-sm w-40">
                                    <option value="Expense">Expense</option>
                                    <option value="Income">Income</option>
                                </select>
                                <button type="button" class="add-category-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">Add</button>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">New categories will appear in the list above. Income items are shown first, then Expense items.</p>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, sendPasswordResetEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCrYUkmMu-KD1e8Mf2-nKsu251SGHCqZKM",
          authDomain: "pelacak-keuangan-pribadi-dae7f.firebaseapp.com",
          projectId: "pelacak-keuangan-pribadi-dae7f",
          storageBucket: "pelacak-keuangan-pribadi-dae7f.firebasestorage.app",
          messagingSenderId: "284126657938",
          appId: "1:284126657938:web:743ab8f900ab087b05954b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    console.log('Firebase initialized. client config projectId=', firebaseConfig.projectId, 'app.options=', app.options || {});

    // Auth/user-scoped state (set when user signs in)
    let currentUser = null;
    let transactionsUnsub = null;
    let categoriesUnsub = null;
    let budgetsUnsubLocal = null;
    // subscription function placeholders (assigned in init)
    let subscribeCategoriesForUser = null;
    let subscribeTransactionsForUser = null;

    // helpers to obtain user-scoped refs
    const getTransactionsCol = (uid) => collection(db, 'users', uid, 'transactions');
    const getCategoriesDoc = (uid) => doc(db, 'users', uid, 'categories', 'user_categories');
    const getBudgetsDocRef = (uid, monthStr) => doc(db, 'users', uid, 'budgets', monthStr);

            // Auto-switch month filter at WIB midnight
            let wibMonthAutoSwitchTimer = null;
            // Helper: get current date in WIB (UTC+7)
            const getWIBDate = (d = new Date()) => {
                const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
                const wib = new Date(utc + (7 * 60 * 60000));
                return wib;
            };
            // Helper: get current WIB month string YYYY-MM
            const getCurrentWIBMonthStr = () => {
                const wib = getWIBDate();
                return `${wib.getFullYear()}-${String(wib.getMonth() + 1).padStart(2, '0')}`;
            };
            function scheduleWIBMonthAutoSwitch() {
                if (wibMonthAutoSwitchTimer) clearTimeout(wibMonthAutoSwitchTimer);
                const now = getWIBDate();
                // Next WIB midnight
                const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
                const msUntilMidnight = nextMidnight.getTime() - now.getTime();
                wibMonthAutoSwitchTimer = setTimeout(() => {
                    // After midnight, update month filter if month changed
                    const newMonthStr = getCurrentWIBMonthStr();
                    if (monthFilter.value !== newMonthStr) {
                        monthFilter.value = newMonthStr;
                        renderDashboard();
                    }
                    scheduleWIBMonthAutoSwitch(); // reschedule for next midnight
                }, msUntilMidnight + 1000); // add 1s buffer
            }

            document.addEventListener('DOMContentLoaded', () => {
            const monthFilter = document.getElementById('month-filter');
            const desktopTbody = document.getElementById('desktop-tbody');
            const mobileCardList = document.getElementById('mobile-card-list');
            const fab = document.getElementById('fab');
            const modal = document.getElementById('modal');
            const exportBtn = document.getElementById('export-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            const incomeVisibilityToggle = document.getElementById('income-visibility-toggle');
            const balanceVisibilityToggle = document.getElementById('balance-visibility-toggle');
            const timePeriodFilter = document.getElementById('time-period-filter');
            const typeFilterButtons = document.getElementById('type-filter-buttons');
            
            const desktopFormContainer = document.getElementById('desktop-form-container');
            const mobileFormContainer = document.getElementById('mobile-form-container');
            const formTemplate = document.getElementById('form-template');

            desktopFormContainer.innerHTML = formTemplate.innerHTML;
            mobileFormContainer.innerHTML = formTemplate.innerHTML;

            // Ensure date inputs default to local today (avoids UTC timezone off-by-one)
            const getLocalIsoToday = () => {
                const d = new Date();
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            };
            try {
                const today = getLocalIsoToday();
                const d1 = desktopFormContainer.querySelector('#date'); if (d1) d1.value = today;
                const d2 = mobileFormContainer.querySelector('#date'); if (d2) d2.value = today;
            } catch (e) { /* safe */ }

            let allTransactions = [];
            let expenseChart;
            let visibilityState = { income: false, balance: false };
            let typeFilter = 'all';
            let budgets = {};
            let budgetsAreAnnual = false; // when true, `budgets` holds annual totals (sum of months)
            let budgetsUnsub = null;

            let categories = { 
                Income: ['Salary', 'Other Income'], 
                Expense: ['Food & Drink', 'Transportation', 'Household Needs', 'Entertainment', 'Bills', 'Sports', 'Fashion', 'Other'] 
            };

            // NOTE: use the user-scoped helper `getBudgetsDocRef(uid, monthStr)` defined above
            // load budgets for the selected month (user-scoped when authenticated)
            const loadBudgetsForYear = async (year) => {
                // aggregate budgets for the whole year by summing each month's budget doc
                budgetsAreAnnual = true;
                // unsubscribe any previous monthly listener
                if (budgetsUnsub) { try { budgetsUnsub(); } catch (e) {} budgetsUnsub = null; }
                if (!currentUser || !currentUser.uid) {
                    budgets = {};
                    categories.Expense.forEach(cat => { if (budgets[cat] == null) budgets[cat] = 0; });
                    renderBudgetEditorForContainer(desktopFormContainer);
                    renderBudgetEditorForContainer(mobileFormContainer);
                    renderDashboard();
                    return;
                }
                try {
                    const monthKeys = Array.from({ length: 12 }, (_, i) => `${year}-${String(i+1).padStart(2, '0')}`);
                    const promises = monthKeys.map(mk => getDoc(getBudgetsDocRef(currentUser.uid, mk)));
                    const snaps = await Promise.all(promises);
                    const agg = {};
                    snaps.forEach(snap => {
                        if (snap && snap.exists && snap.exists()) {
                            const data = snap.data();
                            Object.keys(data || {}).forEach(k => {
                                const v = Number(data[k]) || 0;
                                agg[k] = (agg[k] || 0) + v;
                            });
                        }
                    });
                    // ensure all expense categories have keys
                    categories.Expense.forEach(cat => { if (agg[cat] == null) agg[cat] = 0; });
                    budgets = agg;
                    renderBudgetEditorForContainer(desktopFormContainer);
                    renderBudgetEditorForContainer(mobileFormContainer);
                    renderDashboard();
                } catch (err) {
                    console.error('Error loading annual budgets: ', err);
                    budgets = {};
                    categories.Expense.forEach(cat => { if (budgets[cat] == null) budgets[cat] = 0; });
                    renderBudgetEditorForContainer(desktopFormContainer);
                    renderBudgetEditorForContainer(mobileFormContainer);
                    renderDashboard();
                }
            };

            const loadBudgetsForMonth = (monthStr) => {
                let month = monthStr || monthFilter.value || (new Date()).toISOString().substring(0,7);
                // if month is a year-only string like '2025', load aggregated annual budgets instead
                if (/^[0-9]{4}$/.test(month)) {
                    loadBudgetsForYear(month);
                    return;
                }
                budgetsAreAnnual = false;
                // unsubscribe previous listener
                if (budgetsUnsub) { try { budgetsUnsub(); } catch (e) {} budgetsUnsub = null; }
                // require user
                if (!currentUser || !currentUser.uid) {
                    budgets = {};
                    categories.Expense.forEach(cat => { if (budgets[cat] == null) budgets[cat] = 0; });
                    renderBudgetEditorForContainer(desktopFormContainer);
                    renderBudgetEditorForContainer(mobileFormContainer);
                    renderDashboard();
                    return;
                }
                const ref = getBudgetsDocRef(currentUser.uid, month);
                budgetsUnsub = onSnapshot(ref, (snap) => {
                    budgets = snap.exists() ? snap.data() : {};
                    categories.Expense.forEach(cat => { if (budgets[cat] == null) budgets[cat] = 0; });
                    renderBudgetEditorForContainer(desktopFormContainer);
                    renderBudgetEditorForContainer(mobileFormContainer);
                    renderDashboard();
                }, (err) => {
                    console.error('Error loading budgets: ', err, 'ref.path=', ref && ref.path, 'clientProject=', (app && app.options && app.options.projectId));
                    // fallback to empty budgets
                    budgets = {};
                    categories.Expense.forEach(cat => { if (budgets[cat] == null) budgets[cat] = 0; });
                    renderBudgetEditorForContainer(desktopFormContainer);
                    renderBudgetEditorForContainer(mobileFormContainer);
                    renderDashboard();
                });
            };

            // --- Category management UI (single column list: Income then Expense) ---
            const getAllCategoriesOrdered = () => {
                return [...(categories.Income || []), ...(categories.Expense || [])];
            };

            const renderCategoriesPanel = () => {
                const panels = document.querySelectorAll('.categories-panel');
                if (!panels || panels.length === 0) return;
                // Build a single markup array and populate each panel's list so both desktop and mobile show same content
                const items = [];
                ['Income', 'Expense'].forEach(type => {
                    (categories[type] || []).forEach((cat, idx) => {
                        items.push({ type, cat, idx });
                    });
                });

                panels.forEach(panel => {
                    const list = panel.querySelector('.categories-list');
                    if (!list) return;
                    list.innerHTML = '';
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'py-3 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2';
                        li.dataset.type = item.type; li.dataset.idx = item.idx;
                        li.innerHTML = `
                            <div class="w-full">
                                <div class="text-sm font-medium text-gray-800 dark:text-gray-200">${item.cat}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${item.type}</div>
                            </div>
                            <div class="mt-2 sm:mt-0 sm:ml-4 flex gap-2">
                                <button type="button" class="edit-cat px-3 py-1.5 text-sm rounded-md bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600">Edit</button>
                                <button type="button" class="del-cat px-3 py-1.5 text-sm rounded-md bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-red-600">Delete</button>
                            </div>
                        `;
                        list.appendChild(li);
                    });
                });
            };

            const openCategoriesPanel = () => {
                const panel = document.querySelector('.categories-panel');
                if (!panel) return;
                panel.classList.remove('hidden');
                renderCategoriesPanel();
            };

            const closeCategoriesPanel = () => {
                const panel = document.querySelector('.categories-panel');
                if (!panel) return;
                panel.classList.add('hidden');
            };

            // wire toggles
            const wireCategoryToggles = () => {
                const saveCategories = async () => {
                    try {
                        if (!currentUser || !currentUser.uid) throw new Error('Not authenticated');
                        await setDoc(getCategoriesDoc(currentUser.uid), categories);
                    } catch (err) {
                        console.error('Failed to save categories: ', err);
                        showToast('Failed to save categories to cloud: ' + (err && err.message ? err.message : String(err)), 'error');
                    }
                };
                // Attach manage-categories-toggle to every form instance (desktop + mobile)
                document.querySelectorAll('.manage-categories-toggle').forEach(btn => {
                    btn.removeEventListener('click', btn.__manageCatHandler);
                    btn.__manageCatHandler = (e) => {
                        const form = btn.closest('form');
                        const panel = form ? form.querySelector('.categories-panel') : document.querySelector('.categories-panel');
                        if (!panel) return;
                        const isHidden = panel.classList.contains('hidden');
                        // hide all budget editors across forms
                        document.querySelectorAll('.budget-editor').forEach(be => be.classList.add('hidden'));
                        // toggle this panel
                        if (isHidden) {
                            panel.classList.remove('hidden');
                            renderCategoriesPanel();
                        } else {
                            panel.classList.add('hidden');
                        }
                    };
                    btn.addEventListener('click', btn.__manageCatHandler);
                });

                // delegate edit/delete (works across panels)
                document.body.removeEventListener('click', window.__catClickHandler);
                window.__catClickHandler = async (e) => {
                    const editBtn = e.target.closest('.edit-cat');
                    const delBtn = e.target.closest('.del-cat');
                    // prevent outside-click handler from running when we handle edit/delete
                    if (editBtn || delBtn) {
                        e.stopPropagation();
                    }
                    if (delBtn) {
                        const li = delBtn.closest('li');
                        if (!li) return;
                        const type = li.dataset.type;
                        // get current name from DOM to avoid stale index
                        const nameEl = li.querySelector('.text-sm.font-medium');
                        const currentName = nameEl ? nameEl.textContent.trim() : null;
                        const idx = currentName ? categories[type].indexOf(currentName) : parseInt(li.dataset.idx || '-1', 10);
                        if (idx === -1 || !currentName) {
                            // fallback: search across both types
                            const altType = type === 'Income' ? 'Expense' : 'Income';
                            const altIdx = currentName ? categories[altType].indexOf(currentName) : -1;
                            if (altIdx !== -1) {
                                try {
                                    const ok = await showConfirmModal(`Delete category "${categories[altType][altIdx]}"?`);
                                    if (!ok) return;
                                } catch (e) { return; }
                                categories[altType].splice(altIdx, 1);
                                renderCategoriesPanel();
                                return;
                            }
                            return;
                        }
                        try {
                            const ok = await showConfirmModal(`Delete category "${categories[type][idx]}"?`);
                            if (!ok) return;
                        } catch (e) { return; }
                        categories[type].splice(idx, 1);
                        renderCategoriesPanel();
                        saveCategories();
                    } else if (editBtn) {
                        const li = editBtn.closest('li');
                        if (!li) return;
                        const type = li.dataset.type;
                        const nameEl = li.querySelector('.text-sm.font-medium');
                        const oldName = nameEl ? nameEl.textContent.trim() : (categories[type][parseInt(li.dataset.idx || '0', 10)] || '');
                        // replace li content with edit form (buttons below input for mobile)
                        li.innerHTML = `
                            <div class="w-full flex flex-col gap-2">
                                <input class="edit-input w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 text-sm" />
                                <div class="flex gap-2">
                                    <select class="edit-type bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 text-sm w-36">
                                        <option value="Expense">Expense</option>
                                        <option value="Income">Income</option>
                                    </select>
                                    <button type="button" class="save-edit-btn bg-blue-600 text-white px-4 py-2 rounded-md text-sm">Save</button>
                                    <button type="button" class="cancel-edit-btn bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-md text-sm">Cancel</button>
                                </div>
                            </div>
                        `;
                        // set input/select values safely (avoid HTML attribute escaping issues)
                        const inputEl = li.querySelector('.edit-input');
                        const selectEl = li.querySelector('.edit-type');
                        if (inputEl) inputEl.value = oldName;
                        if (selectEl) selectEl.value = type;
                        // wire buttons using onclick to avoid duplicate listeners
                        const cancelBtn = li.querySelector('.cancel-edit-btn');
                        const saveBtn = li.querySelector('.save-edit-btn');
                        if (cancelBtn) cancelBtn.onclick = () => renderCategoriesPanel();
                        if (saveBtn) saveBtn.onclick = () => {
                            const input = li.querySelector('.edit-input');
                            const newType = li.querySelector('.edit-type').value;
                            const newName = input ? input.value.trim() : '';
                            if (!newName) return showToast('Name cannot be empty', 'warn');
                            // case-insensitive duplicate check
                            const nameExists = (arr, name) => arr.some(a => a.toLowerCase() === name.toLowerCase());
                            if ((nameExists(categories.Income, newName) || nameExists(categories.Expense, newName)) && newName.toLowerCase() !== oldName.toLowerCase()) return showToast('Category already exists', 'warn');
                            // find current index again
                            const currentIdx = categories[type].indexOf(oldName);
                            if (currentIdx !== -1) categories[type].splice(currentIdx, 1);
                            categories[newType].push(newName);
                            renderCategoriesPanel();
                            saveCategories();
                        };
                    }
                };
                document.body.addEventListener('click', window.__catClickHandler);

                // add category buttons: attach to each form's add button
                document.querySelectorAll('.add-category-btn').forEach(addBtn => {
                    addBtn.removeEventListener('click', addBtn.__addHandler);
                    addBtn.__addHandler = (e) => {
                        const form = addBtn.closest('form');
                        const nameInput = form ? form.querySelector('.new-category-name') : document.querySelector('.new-category-name');
                        const typeSelect = form ? form.querySelector('.new-category-type') : document.querySelector('.new-category-type');
                        const name = nameInput.value.trim();
                        const type = typeSelect.value;
                        if (!name) return showToast('Enter category name', 'warn');
                        if (categories.Income.includes(name) || categories.Expense.includes(name)) return showToast('Category already exists', 'warn');
                        categories[type].push(name);
                        nameInput.value = '';
                        renderCategoriesPanel();
                        saveCategories();
                    };
                    addBtn.addEventListener('click', addBtn.__addHandler);
                });
            };
            const accounts = ['Cash', 'Bank', 'E-Wallet', 'Credit Card'];

            const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });

            // --- Number formatting helpers for amount input (thousand separators while typing) ---
            const formatNumberInput = (str) => {
                if (str == null) return '';
                // remove non-digits
                const onlyDigits = String(str).replace(/[^0-9]/g, '');
                if (onlyDigits === '') return '';
                return onlyDigits.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            };

            // Normalize and set transactions array from a list of raw docs; deduplicate by id
            const setAllTransactionsFromRaw = (rawDocs) => {
                const map = new Map();
                rawDocs.forEach(rd => {
                    const id = rd.id;
                    const data = { ...rd.data };
                    if (data.date && typeof data.date === 'object' && typeof data.date.toDate === 'function') {
                        try { data.date = data.date.toDate().toISOString().substring(0,10); } catch(e) { data.date = String(data.date); }
                    }
                    map.set(id, { id, ...data });
                });
                // preserve order by converting map values to array
                allTransactions = Array.from(map.values());
            };

            const parseNumberFromFormatted = (str) => {
                if (!str) return 0;
                const digits = String(str).replace(/[^0-9\-]/g, '');
                return digits === '' ? 0 : parseFloat(digits);
            };

            // Modal helpers
            const showPasswordModal = (placeholderText) => {
                return new Promise((resolve, reject) => {
                    const pm = document.getElementById('password-modal');
                    const input = document.getElementById('password-input');
                    const cancel = document.getElementById('password-cancel');
                    const submit = document.getElementById('password-submit');
                    if (!pm || !input || !cancel || !submit) return reject();
                    input.value = '';
                    input.placeholder = placeholderText || 'Password';
                    pm.classList.remove('hidden');
                    const cleanup = () => { pm.classList.add('hidden'); cancel.onclick = null; submit.onclick = null; };
                    cancel.onclick = () => { cleanup(); reject(); };
                    submit.onclick = () => { const v = input.value; cleanup(); resolve(v); };
                    input.focus();
                });
            };

            const showConfirmModal = (text) => {
                return new Promise((resolve, reject) => {
                    const cm = document.getElementById('confirm-modal');
                    const ctext = document.getElementById('confirm-text');
                    const cancel = document.getElementById('confirm-cancel');
                    const ok = document.getElementById('confirm-ok');
                    if (!cm || !ctext || !cancel || !ok) return reject();
                    ctext.textContent = text || 'Are you sure?';
                    cm.classList.remove('hidden');
                    const cleanup = () => { cm.classList.add('hidden'); cancel.onclick = null; ok.onclick = null; };
                    cancel.onclick = () => { cleanup(); reject(); };
                    ok.onclick = () => { cleanup(); resolve(true); };
                });
            };

            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    // show moon icon in dark mode
                    darkIcon.classList.remove('hidden');
                    lightIcon.classList.add('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    // show sun icon in light mode
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
                localStorage.setItem('theme', theme);
                renderDashboard();
            };

            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                applyTheme(isDark ? 'light' : 'dark');
            });
            
            const updateVisibilityUI = () => {
                document.getElementById('income-eye-open').classList.toggle('hidden', !visibilityState.income);
                document.getElementById('income-eye-closed').classList.toggle('hidden', visibilityState.income);
                document.getElementById('balance-eye-open').classList.toggle('hidden', !visibilityState.balance);
                document.getElementById('balance-eye-closed').classList.toggle('hidden', visibilityState.balance);
                renderDashboard();
            };

            const toggleAllVisibility = () => {
                const isCurrentlyVisible = visibilityState.income;
                if (isCurrentlyVisible) {
                    visibilityState.income = false;
                    visibilityState.balance = false;
                    localStorage.setItem('visibilityState', JSON.stringify(visibilityState));
                    updateVisibilityUI();
                } else {
                    showPasswordModal('Enter password to show amounts:').then(pw => {
                        if (pw === '0124') {
                            visibilityState.income = true;
                            visibilityState.balance = true;
                            localStorage.setItem('visibilityState', JSON.stringify(visibilityState));
                            updateVisibilityUI();
                        } else {
                            showToast('Incorrect password.', 'error');
                        }
                    }).catch(() => {});
                }
            };

            incomeVisibilityToggle.addEventListener('click', toggleAllVisibility);
            balanceVisibilityToggle.addEventListener('click', toggleAllVisibility);

            const updateCategoryOptions = (form) => {
                const typeSelect = form.querySelector('#type');
                const categorySelect = form.querySelector('#category');
                const selectedType = typeSelect.value;
                categorySelect.innerHTML = '';
                categories[selectedType].forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat; option.textContent = cat;
                    categorySelect.appendChild(option);
                });
            };
            
            const populateAccountOptions = (container) => {
                const accSelect = container.querySelector('#account');
                accSelect.innerHTML = '';
                accounts.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc; option.textContent = acc;
                    accSelect.appendChild(option);
                });
            };

            const populateMonthFilter = () => {
                // Populate months based on selected year (Jan..Dec)
                const yearSelect = document.getElementById('year-select');
                const selectedYear = yearSelect ? yearSelect.value : (new Date()).getFullYear().toString();
                // Use WIB month for default selection
                const currentSelection = monthFilter.value || getCurrentWIBMonthStr();
                monthFilter.innerHTML = '';

                // first option: show all months for the selected year (year-only view)
                const allOpt = document.createElement('option');
                allOpt.value = selectedYear; // year-only value like '2025'
                // Don't repeat year here because Year is selected separately
                allOpt.textContent = `All months`;
                monthFilter.appendChild(allOpt);

                // create months Jan..Dec for the selected year
                for (let m = 0; m < 12; m++) {
                    const monthIndex = (m + 1).toString().padStart(2, '0');
                    const monthStr = `${selectedYear}-${monthIndex}`;
                    const date = new Date(parseInt(selectedYear, 10), m, 1);
                    const option = document.createElement('option');
                    option.value = monthStr;
                    // show month name only; selected year is already chosen in the Year select
                    option.textContent = date.toLocaleDateString('en-US', { month: 'long' });
                    monthFilter.appendChild(option);
                }

                // try to preserve previous selection if it's in the same year
                if (currentSelection && currentSelection.startsWith(selectedYear)) {
                    // If currentSelection is not in options, set to current WIB month
                    if (!Array.from(monthFilter.options).some(o => o.value === currentSelection)) {
                        monthFilter.value = getCurrentWIBMonthStr();
                    } else {
                        monthFilter.value = currentSelection;
                    }
                } else {
                        // default: if current year, select current month; otherwise select the year-all option
                        const now = new Date();
                        const currentMonthStr = now.toISOString().substring(0, 7);
                        // Use WIB month for default selection
                        const wibMonthStr = getCurrentWIBMonthStr();
                        if (wibMonthStr.startsWith(selectedYear)) monthFilter.value = wibMonthStr;
                        else monthFilter.value = selectedYear; // year-only default
                }
            };

            const populateYearSelect = () => {
                const yearSelect = document.getElementById('year-select');
                if (!yearSelect) return;
                yearSelect.innerHTML = '';
                // determine earliest and latest years from data (or use last 3 years default)
                const yearsSet = new Set(allTransactions.map(t => (t.date || '').substring(0, 4)).filter(y => y));
                const years = Array.from(yearsSet).map(y => parseInt(y, 10)).filter(n => !isNaN(n)).sort((a,b)=>a-b);
                const now = new Date();
                if (years.length === 0) {
                    // fallback: show current year and two previous years
                    for (let y = now.getFullYear() - 2; y <= now.getFullYear(); y++) {
                        const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y); yearSelect.appendChild(opt);
                    }
                } else {
                    const minY = years[0];
                    const maxY = years[years.length - 1];
                    // if dataset covers >=3 years, show every year between min and max
                    for (let y = minY; y <= maxY; y++) { const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y); yearSelect.appendChild(opt); }
                }
                // set default to current year if available
                const currentYear = String(now.getFullYear());
                if (Array.from(yearSelect.options).some(o=>o.value === currentYear)) yearSelect.value = currentYear;
                // wire change
                yearSelect.onchange = () => populateMonthFilter();
            };

            window.startEditTransaction = (id) => {
                const transaction = allTransactions.find(t => t.id === id);
                if (!transaction) return;

                const isMobile = window.innerWidth < 1024;
                const container = isMobile ? mobileFormContainer : desktopFormContainer;
                // require password for editing Income
                if (transaction.type === 'Income') {
                    showPasswordModal('Enter password to edit Income:').then(pw => {
                        if (pw !== '0124') return showToast('Incorrect password.', 'error');
                        proceedEdit();
                    }).catch(() => {});
                } else {
                    proceedEdit();
                }

                function proceedEdit() {
                const form = container.querySelector('form');
                
                form.querySelector('#transaction-id').value = transaction.id;
                form.querySelector('#date').value = transaction.date;
                form.querySelector('#description').value = transaction.description;
                // populate formatted amount (thousand separators)
                form.querySelector('#amount').value = formatNumberInput(String(transaction.amount));
                form.querySelector('#type').value = transaction.type;
                updateCategoryOptions(form);
                form.querySelector('#category').value = transaction.category;
                form.querySelector('#account').value = transaction.account;
                container.querySelector('#form-title').textContent = 'Edit Transaction';
                container.querySelector('#submit-btn').textContent = 'Update Transaction';
                container.querySelector('#cancel-edit-btn').classList.remove('hidden');
                
                    if (isMobile) {
                        modal.classList.remove('hidden');
                    } else {
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            };

            window.deleteTransaction = async (id) => {
                try {
                    const ok = await showConfirmModal('Are you sure you want to delete this transaction?');
                    if (ok) {
                        if (!currentUser || !currentUser.uid) throw new Error('Not authenticated');
                        await deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', id));
                    }
                } catch (e) {
                    // modal cancelled or error
                }
            };

            const renderTable = (transactionsToRender) => {
                desktopTbody.innerHTML = '';
                mobileCardList.innerHTML = '';

                if (transactionsToRender.length === 0) {
                    const noDataMessage = 'No transactions for this period.';
                    desktopTbody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">${noDataMessage}</td></tr>`;
                    mobileCardList.innerHTML = `<div class="text-center py-10 text-gray-500 dark:text-gray-400">${noDataMessage}</div>`;
                    return;
                }

                const sortedTransactions = [...transactionsToRender].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedTransactions.forEach(t => {
                    const amountDisplay = t.type === 'Income' && !visibilityState.income ? '***' : formatCurrency(t.amount);
                    
                    const row = document.createElement('tr');
                    row.className = t.type === 'Income' ? 'bg-green-50/50 dark:bg-green-900/20' : 'bg-red-50/50 dark:bg-red-900/20';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatDate(t.date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${t.type === 'Income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${amountDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${t.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t.type === 'Income' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                ${t.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${t.account}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button type="button" onclick="startEditTransaction('${t.id}')" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 mr-3">Edit</button>
                            <button type="button" onclick="deleteTransaction('${t.id}')" class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300">Delete</button>
                        </td>
                    `;
                    desktopTbody.appendChild(row);

                    const card = document.createElement('div');
                    card.className = `p-2 rounded-lg shadow-sm ${t.type === 'Income' ? 'bg-green-50/50 dark:bg-green-900/20' : 'bg-red-50/50 dark:bg-red-900/20'}`;
                    card.innerHTML = `
                        <div class="flex items-center justify-between gap-2">
                            <div class="min-w-0">
                                <div class="font-medium text-sm truncate text-gray-900 dark:text-gray-100">${t.description}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(t.date)}  ${t.category}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-base whitespace-nowrap ${t.type === 'Income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${amountDisplay}</div>
                                <div class="mt-1 flex items-center justify-end gap-2">
                                    <button type="button" onclick="startEditTransaction('${t.id}')" class="text-xs text-indigo-600 dark:text-indigo-400">Edit</button>
                                    <button type="button" onclick="deleteTransaction('${t.id}')" class="text-xs text-red-600 dark:text-red-400">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                    mobileCardList.appendChild(card);
                });
            };

            const renderDashboard = () => {
                const selectedMonth = monthFilter.value;
                if (!selectedMonth) return;

                // if monthFilter value is a 4-digit year (e.g., '2025'), treat as year-all
                const isYearOnly = /^[0-9]{4}$/.test(selectedMonth);
                let monthFilteredTransactions;
                if (isYearOnly) {
                    monthFilteredTransactions = allTransactions.filter(t => t.date.startsWith(selectedMonth));
                } else {
                    monthFilteredTransactions = allTransactions.filter(t => t.date.startsWith(selectedMonth));
                }

                const totalIncome = monthFilteredTransactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
                const totalExpense = monthFilteredTransactions.filter(t => t.type === 'Expense').reduce((sum, t) => sum + t.amount, 0);
                const netBalance = totalIncome - totalExpense;

                document.getElementById('total-income').textContent = visibilityState.income ? formatCurrency(totalIncome) : '***';
                document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
                document.getElementById('net-balance').textContent = visibilityState.balance ? formatCurrency(netBalance) : '***';

                renderExpenseChart(monthFilteredTransactions, isYearOnly, selectedMonth);
                renderBudgetStatus(monthFilteredTransactions, isYearOnly, selectedMonth);

                // if trend view active, update trend chart
                const trendVisible = !document.getElementById('trend-canvas-wrapper').classList.contains('hidden');
                if (trendVisible) {
                    const monthFilterEl = document.getElementById('month-filter');
                    const endKey = monthFilterEl ? monthFilterEl.value : undefined;
                    renderTrendChart(allTransactions, parseInt(trendRange.value || '6', 10), endKey);
                }

                let finalFilteredTransactions;
                const timePeriod = timePeriodFilter.value;
                const now = new Date();
                if(timePeriod === 'month') {
                    finalFilteredTransactions = monthFilteredTransactions;
                } else if(timePeriod === 'week') {
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
                    startOfWeek.setHours(0,0,0,0);
                    finalFilteredTransactions = allTransactions.filter(t => new Date(t.date) >= startOfWeek);
                } else if (timePeriod === 'year') {
                    const yearStr = now.getFullYear().toString();
                    finalFilteredTransactions = allTransactions.filter(t => t.date.startsWith(yearStr));
                }
                
                if (typeFilter !== 'all') {
                    finalFilteredTransactions = finalFilteredTransactions.filter(t => t.type === typeFilter);
                }
                // apply search filter (description) - works on mobile and desktop
                const searchInput = document.getElementById('search-input');
                if (searchInput && searchInput.value.trim() !== '') {
                    const q = searchInput.value.trim().toLowerCase();
                    finalFilteredTransactions = finalFilteredTransactions.filter(t => (t.description || '').toLowerCase().includes(q));
                }
                renderTable(finalFilteredTransactions);
            };
            
            const renderExpenseChart = (filteredTransactions, isYearOnly = false, selectedKey) => {
                const canvas = document.getElementById('expense-chart');
                const noDataMessage = document.getElementById('no-expense-message');
                const ctx = canvas.getContext('2d');
                
                const expenseByCategory = {};
                filteredTransactions
                    .filter(t => t.type === 'Expense')
                    .forEach(t => {
                        expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
                    });

                const labels = Object.keys(expenseByCategory);
                const expenseData = Object.values(expenseByCategory);

                // update total display (monthly total or year total)
                const total = expenseData.reduce((s, v) => s + v, 0);
                const distTotalEl = document.getElementById('distribution-total');
                if (distTotalEl) distTotalEl.textContent = 'Total: ' + formatCurrency(total) + (isYearOnly ? `  Year ${selectedKey}` : '');

                if (expenseChart) {
                    expenseChart.destroy();
                }

                if (expenseData.length === 0 || expenseData.every(item => item === 0)) {
                    canvas.classList.add('hidden');
                    noDataMessage.classList.remove('hidden');
                    return;
                }
                
                // adjust wrapper height based on number of non-zero categories so chart scales nicely
                const distWrap = document.getElementById('distribution-canvas-wrapper');
                const nonZeroCount = expenseData.filter(v => v > 0).length || labels.length;
                // determine height: base 220px, add 24px per category up to a max
                const base = 220;
                const per = 22;
                const max = 520;
                const desired = Math.min(max, base + (nonZeroCount - 1) * per);
                if (distWrap) distWrap.style.height = desired + 'px';

                canvas.classList.remove('hidden');
                noDataMessage.classList.add('hidden');

                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Expense',
                            data: expenseData,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                                'rgba(99, 255, 132, 0.7)', 'rgba(235, 54, 162, 0.7)'
                            ],
                            borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#F9F5F0',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'top',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6b7280'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed !== null) { label += formatCurrency(context.parsed); }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            // Trend chart: Income vs Expense over last N months
            let trendChart = null;
            // returns array of month keys like '2025-08', ending at optional endMonth (YYYY-MM) or current month
            const getMonthsArray = (count, endMonth) => {
                const months = [];
                let endDate;
                if (endMonth && typeof endMonth === 'string' && /^\d{4}-\d{2}$/.test(endMonth)) {
                    const [y, m] = endMonth.split('-');
                    endDate = new Date(parseInt(y,10), parseInt(m,10)-1, 1);
                } else {
                    endDate = new Date();
                    endDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
                }
                for (let i = count - 1; i >= 0; i--) {
                    const d = new Date(endDate.getFullYear(), endDate.getMonth() - i, 1);
                    // Use local year/month to avoid UTC-based toISOString shifting the date to previous month
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    months.push(key);
                }
                return months;
            };

            const computeMonthlyTotals = (transactions, months) => {
                const incomeTotals = months.map(m => 0);
                const expenseTotals = months.map(m => 0);
                transactions.forEach(t => {
                    const m = t.date.substring(0,7);
                    const idx = months.indexOf(m);
                    if (idx === -1) return;
                    if (t.type === 'Income') incomeTotals[idx] += t.amount;
                    else if (t.type === 'Expense') expenseTotals[idx] += t.amount;
                });
                return { incomeTotals, expenseTotals };
            };

            const renderTrendChart = (allTx, monthsCount, endMonth) => {
                // endMonth: optional 'YYYY-MM' string; if not provided, use the current month filter if available
                const monthFilterEl = document.getElementById('month-filter');
                const endKey = endMonth || (monthFilterEl ? monthFilterEl.value : undefined);
                const months = getMonthsArray(monthsCount, endKey);
                const { incomeTotals, expenseTotals } = computeMonthlyTotals(allTx, months);
                const labels = months.map(m => {
                    const [y, mm] = m.split('-');
                    const d = new Date(y, parseInt(mm,10)-1);
                    return d.toLocaleString('en-US', { month: 'short', year: 'numeric' });
                });

                const ctx2 = document.getElementById('trend-chart').getContext('2d');
                if (trendChart) { trendChart.destroy(); trendChart = null; }
                trendChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Income', data: incomeTotals, borderColor: 'rgba(34,197,94,0.95)', backgroundColor: 'rgba(34,197,94,0.12)', tension: 0.3, pointRadius: 3, pointHoverRadius: 6 },
                            { label: 'Expense', data: expenseTotals, borderColor: 'rgba(239,68,68,0.95)', backgroundColor: 'rgba(239,68,68,0.12)', tension: 0.3, pointRadius: 3, pointHoverRadius: 6 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 250 },
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    label: function(ctx) {
                                        const val = ctx.raw || 0;
                                        return ctx.dataset.label + ': ' + new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { display: true, ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } },
                            y: { beginAtZero: true, ticks: { callback: val => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val) } }
                        }
                    }
                });
            };

            // Toggle UI for distribution <-> trend using the same filter style as transaction filters
            const btnDistribution = document.getElementById('btn-distribution');
            const btnTrend = document.getElementById('btn-trend');
            const trendControls = document.getElementById('trend-controls');
            const trendRange = document.getElementById('trend-range');

            function setActiveToggle(activeBtn) {
                if (!btnDistribution || !btnTrend) return;
                btnDistribution.classList.remove('filter-btn-active');
                btnTrend.classList.remove('filter-btn-active');
                activeBtn.classList.add('filter-btn-active');

                // control visibility of budget vs trend-analysis
                const budgetEl = document.getElementById('budget-status');
                const analysisEl = document.getElementById('trend-analysis-cards');
                if (activeBtn === btnDistribution) {
                    if (budgetEl) budgetEl.classList.remove('hidden');
                    if (analysisEl) analysisEl.classList.add('hidden');
                } else {
                    if (budgetEl) budgetEl.classList.add('hidden');
                    if (analysisEl) analysisEl.classList.remove('hidden');
                }
            }

            // initialize default state to Distribution active
            setActiveToggle(btnDistribution);

            btnDistribution.addEventListener('click', () => {
                const distWrap = document.getElementById('distribution-canvas-wrapper');
                const trendWrap = document.getElementById('trend-canvas-wrapper');
                if (distWrap) distWrap.classList.remove('hidden');
                if (trendWrap) trendWrap.classList.add('hidden');
                if (trendControls) trendControls.classList.add('hidden');
                setActiveToggle(btnDistribution);
            });

            btnTrend.addEventListener('click', () => {
                const distWrap = document.getElementById('distribution-canvas-wrapper');
                const trendWrap = document.getElementById('trend-canvas-wrapper');
                if (distWrap) distWrap.classList.add('hidden');
                if (trendWrap) trendWrap.classList.remove('hidden');
                if (trendControls) trendControls.classList.remove('hidden');
                setActiveToggle(btnTrend);
                try { 
                    const monthFilterEl = document.getElementById('month-filter');
                    const endKey = monthFilterEl ? monthFilterEl.value : undefined;
                    renderTrendChart(allTransactions, parseInt(trendRange.value || '6', 10), endKey);
                } catch (e) { /* trend renderer not available */ }
            });

            // When the trend range changes (6/12 months), re-render the trend chart if Trend tab is active
            if (trendRange) {
                trendRange.addEventListener('change', () => {
                    try {
                        const monthFilterEl = document.getElementById('month-filter');
                        const endKey = monthFilterEl ? monthFilterEl.value : undefined;
                        if (btnTrend && btnTrend.classList.contains('filter-btn-active')) {
                            renderTrendChart(allTransactions, parseInt(trendRange.value || '6', 10), endKey);
                        }
                    } catch (e) { /* safe */ }
                });
            }

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                const currentForm = e.target;
                const currentSubmitBtn = currentForm.querySelector('#submit-btn');
                currentSubmitBtn.disabled = true;

                const id = currentForm.querySelector('#transaction-id').value;
                // parse formatted amount (e.g., "25.000") into numeric
                const rawAmount = currentForm.querySelector('#amount').value;
                const numericAmount = parseNumberFromFormatted(rawAmount);
                const transactionData = {
                    date: currentForm.querySelector('#date').value,
                    description: currentForm.querySelector('#description').value,
                    amount: numericAmount,
                    type: currentForm.querySelector('#type').value,
                    category: currentForm.querySelector('#category').value,
                    account: currentForm.querySelector('#account').value
                };
                try {
                    if (!currentUser || !currentUser.uid) throw new Error('Not authenticated');
                    if (id) {
                        await updateDoc(doc(db, 'users', currentUser.uid, 'transactions', id), transactionData);
                        console.log('Updated transaction', id);
                    } else {
                        const ref = await addDoc(getTransactionsCol(currentUser.uid), transactionData);
                        console.log('Added transaction', ref.id, 'for user', currentUser.uid, transactionData);
                        try {
                            // attempt a direct server read to confirm the document was persisted
                            const serverDocRef = doc(db, 'users', currentUser.uid, 'transactions', ref.id);
                            const serverSnap = await getDoc(serverDocRef);
                            console.log('Server read after add - exists:', serverSnap.exists(), 'data:', serverSnap.exists() ? serverSnap.data() : null);
                        } catch (e) {
                            console.error('Server read after add failed:', e);
                        }
                        try {
                            // optimistic update so UI shows immediately while snapshot syncs
                            const optimistic = { id: ref.id, ...transactionData };
                            // avoid duplicate optimistic entry if a snapshot already contains this id
                            if (!allTransactions.some(t => t.id === ref.id)) {
                                allTransactions.push(optimistic);
                            }
                            try { populateMonthFilter(); } catch (e) {}
                            renderDashboard();
                            try { updateTrendAnalysisCards(allTransactions); } catch (e) {}
                        } catch (e) { console.error('Optimistic update failed: ', e); }
                    }
                    resetFormState();
                } catch (error) {
                    console.error("Error saving transaction: ", error);
                    showToast("Failed to save transaction: " + (error && error.message ? error.message : String(error)), 'error', 5000);
                } finally {
                    currentSubmitBtn.disabled = false;
                }
            };
            
            // return local date in YYYY-MM-DD (avoids timezone UTC shift issues)
            const formatLocalDateISO = (date = new Date()) => {
                const d = date;
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            };

            const resetFormState = () => {
                const containers = [desktopFormContainer, mobileFormContainer];
                containers.forEach(container => {
                    const formToReset = container.querySelector('#transaction-form');
                    if (formToReset) {
                        formToReset.reset();
                        container.querySelector('#transaction-id').value = '';
                        // set date input using local-date ISO string to avoid timezone off-by-one
                        const dateEl = container.querySelector('#date');
                        if (dateEl) dateEl.value = formatLocalDateISO(new Date());
                        container.querySelector('#form-title').textContent = 'Add Transaction';
                        container.querySelector('#submit-btn').textContent = 'Save';
                        container.querySelector('#cancel-edit-btn').classList.add('hidden');
                        updateCategoryOptions(formToReset);
                    }
                });
                modal.classList.add('hidden');
            };
            
            const exportToExcel = () => {
                showPasswordModal('Enter password to export data:').then(password => {
                    if (password === '0124') {
                        const selectedKey = monthFilter.value;
                        const selectedLabel = monthFilter.options[monthFilter.selectedIndex].text;
                        let filteredTransactions;
                        if (/^[0-9]{4}$/.test(selectedKey)) {
                            // year-only
                            filteredTransactions = allTransactions.filter(t => t.date.startsWith(selectedKey));
                        } else {
                            filteredTransactions = allTransactions.filter(t => t.date.startsWith(selectedKey));
                        }

                        if (filteredTransactions.length === 0) {
                            showToast('No data to export for the selected period.', 'error');
                            return;
                        }

                        const dataForExport = filteredTransactions.map(t => ({
                            Date: formatDate(t.date),
                            Description: t.description,
                            Category: t.category,
                            Type: t.type,
                            Account: t.account,
                            Amount: t.amount
                        }));

                        const totalIncome = filteredTransactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
                        const totalExpense = filteredTransactions.filter(t => t.type === 'Expense').reduce((sum, t) => sum + t.amount, 0);

                        const worksheet = XLSX.utils.json_to_sheet(dataForExport);
                        
                        XLSX.utils.sheet_add_aoa(worksheet, [
                            [],
                            ["SUMMARY"],
                            ["Total Income", totalIncome],
                            ["Total Expense", totalExpense],
                            ["Balance", totalIncome - totalExpense]
                        ], { origin: -1 });

                        const workbook = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(workbook, worksheet, "Financial Report");
                        XLSX.writeFile(workbook, `Financial Report - ${selectedLabel}.xlsx`);
                    } else {
                        showToast('Incorrect password.', 'error');
                    }
                }).catch(() => {});
            };

            const renderBudgetEditorForContainer = (container) => {
                const toggleBtn = container.querySelector('.toggle-budget-editor');
                const editor = container.querySelector('.budget-editor');
                const fields = container.querySelector('.budget-fields');
                const saveBtn = container.querySelector('.save-budgets-btn');
                const resetBtn = container.querySelector('.reset-budgets-btn');

                const buildFields = () => {
                    fields.innerHTML = '';
                    categories.Expense.forEach(cat => {
                        const row = document.createElement('div');
                        row.className = 'flex items-center gap-2';
                        // show empty string if budget is zero so user sees blank input
                        const displayVal = (budgets[cat] || 0) === 0 ? '' : formatNumberInput(String(budgets[cat] || 0));
                        row.innerHTML = `
                            <label class="w-1/2 text-sm text-gray-700 dark:text-gray-300">${cat}</label>
                            <input type="text" inputmode="numeric" data-cat="${cat}" value="${displayVal}" class="w-1/2 block bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1 text-sm budget-input" />
                        `;
                        fields.appendChild(row);
                    });
                };

                if (!toggleBtn) return;
                // attach per-form toggle and ensure mutual hide with categories panel
                toggleBtn.removeEventListener('click', toggleBtn.__toggleHandler);
                toggleBtn.__toggleHandler = () => {
                    const form = toggleBtn.closest('form');
                    const panel = form ? form.querySelector('.categories-panel') : null;
                    const isHidden = editor.classList.contains('hidden');
                    // hide all category panels first
                    document.querySelectorAll('.categories-panel').forEach(p => p.classList.add('hidden'));
                    // toggle this editor
                    if (isHidden) {
                        editor.classList.remove('hidden');
                        buildFields();
                    } else {
                        editor.classList.add('hidden');
                    }
                    // also ensure other forms' editors are hidden
                    document.querySelectorAll('.budget-editor').forEach(be => { if (be !== editor) be.classList.add('hidden'); });
                };
                toggleBtn.addEventListener('click', toggleBtn.__toggleHandler);

                // ensure we don't attach duplicate listeners when re-rendering
                saveBtn.onclick = null;
                saveBtn.onclick = async () => {
                    if (budgetsAreAnnual) {
                        showToast('Budget editing is disabled while viewing annual aggregates. Please select a specific month to edit monthly budgets.', 'info');
                        return;
                    }
                    const newBudgets = { ...budgets };
                    fields.querySelectorAll('input[data-cat]').forEach(input => {
                        const c = input.dataset.cat;
                        const val = input.value || '';
                        newBudgets[c] = parseNumberFromFormatted(val) || 0;
                    });
                    try {
                        const month = monthFilter.value || (new Date()).toISOString().substring(0,7);
                        if (!currentUser || !currentUser.uid) throw new Error('Not authenticated');
                        await setDoc(getBudgetsDocRef(currentUser.uid, month), newBudgets);
                        budgets = newBudgets;
                        showToast('Budgets saved successfully.', 'success');
                        renderBudgetEditorForContainer(container);
                        renderDashboard();
                    } catch (e) {
                        console.error("Error saving budgets: ", e);
                        showToast('Failed to save budgets: ' + (e && e.message ? e.message : String(e)), 'error');
                    }
                };

                resetBtn.onclick = null;
                resetBtn.onclick = async () => {
                    try {
                        const ok = await showConfirmModal('Reset all budgets to 0?');
                        if (!ok) return;
                    } catch (e) { return; }
                    const newBudgets = {};
                    categories.Expense.forEach(cat => newBudgets[cat] = 0);
                    try {
                        const month = monthFilter.value || (new Date()).toISOString().substring(0,7);
                        if (!currentUser || !currentUser.uid) throw new Error('Not authenticated');
                        await setDoc(getBudgetsDocRef(currentUser.uid, month), newBudgets);
                        budgets = newBudgets;
                        showToast('Budgets have been reset.', 'success');
                        renderBudgetEditorForContainer(container);
                        renderDashboard();
                    } catch (e) {
                        console.error('Error resetting budgets: ', e);
                        showToast('Failed to reset budgets: ' + (e && e.message ? e.message : String(e)), 'error');
                    }
                };

                buildFields();
                // attach formatting behavior to budget inputs
                fields.querySelectorAll('.budget-input').forEach(inp => {
                    inp.addEventListener('input', () => { inp.value = formatNumberInput(inp.value); try { inp.selectionStart = inp.selectionEnd = inp.value.length; } catch(e){} });
                    inp.addEventListener('blur', () => { inp.value = formatNumberInput(inp.value); });
                });
            };
            
            const renderBudgetStatus = (filteredTransactionsArg, isYearOnly = false, selectedKey) => {
                const container = document.getElementById('budget-status');
                if (!container) return;
                
                const spentByCategory = {};
                categories.Expense.forEach(cat => spentByCategory[cat] = 0);
                filteredTransactionsArg.filter(t => t.type === 'Expense').forEach(t => {
                    spentByCategory[t.category] = (spentByCategory[t.category] || 0) + t.amount;
                });
                container.innerHTML = '';
                let visibleCount = 0;
                categories.Expense.forEach(cat => {
                    const spent = spentByCategory[cat] || 0;
                    let budget = budgets[cat] || 0;
                    let displayBudget = budget;
                    if (isYearOnly) {
                        // budgets are stored per-month; show annualized budget (monthly * 12)
                        displayBudget = budget * 12;
                    }
                    if (!displayBudget || displayBudget === 0) return;
                    const remaining = displayBudget - spent;
                    const over = displayBudget > 0 && spent > displayBudget;
                    const percentUsed = displayBudget > 0 ? Math.min(100, Math.round((spent / displayBudget) * 100)) : (spent > 0 ? 100 : 0);
                    const card = document.createElement('div');
                    // compact style: small text, concise layout (suitable for mobile)
                    card.className = 'p-2 rounded-lg border text-sm ' + (over ? 'border-red-300 bg-red-50 dark:bg-red-900/30' : 'border-gray-200 bg-white dark:bg-gray-800');
                    card.innerHTML = `
                        <div class="flex items-center justify-between gap-2">
                            <div class="min-w-0">
                                <div class="font-semibold truncate ${over ? 'text-red-700 dark:text-red-200' : 'text-gray-700 dark:text-gray-200'}">${cat}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">B ${formatCurrency(displayBudget)}  R ${formatCurrency(remaining)}${isYearOnly ? '  (annual)' : ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold ${over ? 'text-red-600 dark:text-red-300' : 'text-gray-800 dark:text-gray-100'}">${formatCurrency(spent)}</div>
                                <div class="text-xs ${over ? 'text-red-600' : 'text-gray-500'}">${displayBudget === 0 ? 'No budget' : (over ? `Over ${formatCurrency(Math.abs(remaining))}` : `${percentUsed}%`)}</div>
                            </div>
                        </div>
                        <div class="w-full mt-2 bg-gray-200 dark:bg-gray-700 rounded-full h-1 overflow-hidden">
                            <div style="width: ${percentUsed}%" class="h-1 ${over ? 'bg-red-500' : 'bg-blue-500'}"></div>
                        </div>
                    `;
                    container.appendChild(card);
                    visibleCount++;
                });

                if (visibleCount === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400">No budgets set. Use Manage Budgets to add budgets for categories.</div>';
                }
            };

            typeFilterButtons.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    typeFilter = e.target.dataset.filter;
                    typeFilterButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('filter-btn-active'));
                    e.target.classList.add('filter-btn-active');
                    renderDashboard();
                }
            });

            const desktopForm = desktopFormContainer.querySelector('form');
            const mobileForm = mobileFormContainer.querySelector('form');

            // attach amount formatting listeners for desktop & mobile forms
            const attachAmountFormatting = (form) => {
                if (!form) return;
                const amt = form.querySelector('#amount');
                if (!amt) return;
                amt.addEventListener('input', () => {
                    const newVal = formatNumberInput(amt.value);
                    amt.value = newVal;
                    try { amt.selectionStart = amt.selectionEnd = amt.value.length; } catch (e) {}
                });
                amt.addEventListener('blur', () => { amt.value = formatNumberInput(amt.value); });
            };

            attachAmountFormatting(desktopForm);
            attachAmountFormatting(mobileForm);

            desktopForm.addEventListener('submit', handleFormSubmit);
            mobileForm.addEventListener('submit', handleFormSubmit);

            desktopForm.querySelector('#type').addEventListener('change', () => updateCategoryOptions(desktopForm));
            mobileForm.querySelector('#type').addEventListener('change', () => updateCategoryOptions(mobileForm));

            desktopForm.querySelector('#cancel-edit-btn').addEventListener('click', resetFormState);
            mobileForm.querySelector('#cancel-edit-btn').addEventListener('click', resetFormState);

            fab.addEventListener('click', () => {
                resetFormState();
                modal.classList.remove('hidden');
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    resetFormState();
                }
            });
            monthFilter.addEventListener('change', () => {
                loadBudgetsForMonth();
                renderDashboard();
                try {
                    const monthFilterEl = document.getElementById('month-filter');
                    const endKey = monthFilterEl ? monthFilterEl.value : undefined;
                    if (btnTrend && btnTrend.classList.contains('filter-btn-active')) {
                        renderTrendChart(allTransactions, parseInt(trendRange.value || '6', 10), endKey);
                    }
                } catch (e) { /* safe */ }
            });
            timePeriodFilter.addEventListener('change', renderDashboard);
            exportBtn.addEventListener('click', exportToExcel);
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');
            const parseImportedRows = (file, cb) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = e.target.result;
                    let workbook;
                    try {
                        workbook = XLSX.read(data, { type: 'binary' });
                    } catch (err) {
                        cb(err);
                        return;
                    }
                    const firstSheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    cb(null, json);
                };
                // choose correct readAs for binary files vs csv
                const name = file.name || '';
                if (name.toLowerCase().endsWith('.csv')) reader.readAsText(file);
                else reader.readAsBinaryString(file);
            };

            const normalizeImported = (rows) => {
                // expect columns: Date, Description, Category, Type, Account, Amount (case-insensitive)
                const normalized = [];
                rows.forEach(r => {
                    const keys = Object.keys(r);
                    const map = {};
                    keys.forEach(k => map[k.trim().toLowerCase()] = r[k]);
                    const dateVal = map['date'] || map['tanggal'] || map['tgl'] || '';
                    const desc = map['description'] || map['keterangan'] || '';
                    const cat = map['category'] || map['kategori'] || '';
                    const type = (map['type'] || map['tipe'] || '').toString() || (Number(map['amount']) < 0 ? 'Expense' : 'Income');
                    const account = map['account'] || map['akun'] || '';
                    const amtRaw = map['amount'] || map['jumlah'] || map['nominal'] || 0;
                    const amt = parseFloat(String(amtRaw).toString().replace(/[^0-9\-\.]/g, '')) || 0;
                    // coerce date to YYYY-MM-DD if possible
                    let dateStr = '';
                    try {
                        const d = new Date(dateVal);
                        if (!isNaN(d.getTime())) dateStr = d.toISOString().substring(0,10);
                    } catch (e) {}
                    normalized.push({ date: dateStr || (new Date()).toISOString().substring(0,10), description: desc, category: cat || 'Other', type: type || 'Expense', account: account || 'Cash', amount: Math.abs(amt) });
                });
                return normalized;
            };

            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                parseImportedRows(file, async (err, rows) => {
                    if (err) return showToast('Failed to parse file: ' + (err && err.message ? err.message : String(err)), 'error');
                    if (!rows || rows.length === 0) return showToast('No rows found in the file.', 'error');
                    const normalized = normalizeImported(rows);
                    // show confirm modal
                    try {
                        const ok = await showConfirmModal(`Import ${normalized.length} rows into transactions?`);
                        if (!ok) return;
                    } catch (e) { return; }

                    // insert transactions: if authenticated, add to Firestore; else add to local state
                    if (currentUser && currentUser.uid) {
                        try {
                            for (const tx of normalized) {
                                await addDoc(getTransactionsCol(currentUser.uid), tx);
                            }
                            showToast('Import completed successfully.', 'success');
                        } catch (e) {
                            console.error('Import to Firestore failed: ', e);
                            showToast('Import failed: ' + (e && e.message ? e.message : String(e)), 'error');
                        }
                    } else {
                        // optimistic local insert
                        normalized.forEach(tx => {
                            const id = 'local-' + Math.random().toString(36).slice(2,9);
                            allTransactions.push({ id, ...tx });
                        });
                        try { populateYearSelect(); } catch (e) {}
                        populateMonthFilter();
                        renderDashboard();
                        showToast('Import completed locally (not saved to cloud). Sign in to persist to Firestore.', 'info', 6000);
                    }
                    importFileInput.value = '';
                });
            });
            const searchInputEl = document.getElementById('search-input');
            if (searchInputEl) searchInputEl.addEventListener('input', renderDashboard);
            // Toast & UI helpers
            const toastContainer = document.getElementById('toast-container');
            const showToast = (msg, type = 'info', ttl = 4000) => {
                try {
                    if (!toastContainer) return; 
                    const el = document.createElement('div');
                    el.className = 'toast max-w-xs w-full px-4 py-2 rounded shadow-lg text-sm text-white';
                    el.style.opacity = '0';
                    if (type === 'error') el.classList.add('bg-red-600');
                    else if (type === 'success') el.classList.add('bg-green-600');
                    else el.classList.add('bg-gray-800');
                    el.textContent = msg;
                    toastContainer.appendChild(el);
                    // animate
                    requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transition = 'opacity 200ms'; });
                    setTimeout(() => {
                        el.style.opacity = '0';
                        setTimeout(() => { try { toastContainer.removeChild(el); } catch (e) {} }, 250);
                    }, ttl);
                } catch (e) { console.error('showToast error', e); }
            };

            // spinner helpers: inject simple inline svg
            const injectSpinner = (btn) => {
                if (!btn) return;
                btn.dataset._orig = btn.innerHTML;
                btn.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>' + (btn.dataset._text || btn.textContent || '');
                btn.disabled = true;
            };
            const removeSpinner = (btn) => {
                if (!btn) return;
                try { if (btn.dataset._orig !== undefined) btn.innerHTML = btn.dataset._orig; } catch (e) {}
                btn.disabled = false;
            };

            // Auth failure cooldown
            let authFailCount = 0;
            let authCooldownUntil = 0; // timestamp ms
            const AUTH_FAIL_LIMIT = 5;
            const AUTH_COOLDOWN_MS = 60 * 1000; // 60s cooldown after limit

            const isAuthCooldown = () => {
                return Date.now() < (authCooldownUntil || 0);
            };

            const recordAuthFailure = () => {
                authFailCount = (authFailCount || 0) + 1;
                if (authFailCount >= AUTH_FAIL_LIMIT) {
                    authCooldownUntil = Date.now() + AUTH_COOLDOWN_MS;
                    showToast('Too many failed attempts. Try again in 60 seconds.', 'error', 5000);
                }
            };

            // Map Firebase auth errors to user-friendly messages
            const authErrorToMessage = (err) => {
                if (!err) return 'Authentication failed. Please try again.';
                const code = (err.code || '').toString();
                switch (code) {
                    case 'auth/user-not-found': return 'No account found for that email. Would you like to register?';
                    case 'auth/wrong-password': return 'Incorrect password. Try again or reset your password.';
                    case 'auth/invalid-email': return 'Please enter a valid email address.';
                    case 'auth/user-disabled': return 'This account has been disabled. Contact support.';
                    case 'auth/network-request-failed': return 'Network error. Check your connection and try again.';
                    case 'auth/email-already-in-use': return 'This email is already registered. Try signing in.';
                    case 'auth/weak-password': return 'Password is too weak. Use at least 6 characters.';
                    default: return err && err.message ? err.message : 'Authentication failed. Please try again.';
                }
            };

            // Show an inline message on the full-login page (keeps toasts for global notifications)
            const showFullLoginMessage = (msg, type = 'error') => {
                if (!fullLoginMsg) return;
                fullLoginMsg.textContent = msg;
                fullLoginMsg.classList.remove('hidden');
                fullLoginMsg.classList.remove('text-green-600','text-yellow-600','text-red-600');
                if (type === 'success') fullLoginMsg.classList.add('text-green-600');
                else if (type === 'warn') fullLoginMsg.classList.add('text-yellow-600');
                else fullLoginMsg.classList.add('text-red-600');
                // hide after a while
                setTimeout(() => { try { fullLoginMsg.classList.add('hidden'); } catch (e) {} }, 6000);
            };

            // --- Firebase Auth setup & UI wiring ---
            const auth = getAuth();
            // prefer persistent login across sessions
            try { setPersistence(auth, browserLocalPersistence).catch(() => {}); } catch (e) { /* ignore */ }

            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('user-info');
            const userEmailSpan = document.getElementById('user-email');
            const authModal = document.getElementById('auth-modal');
            const authTitle = document.getElementById('auth-modal-title');
            const authEmail = document.getElementById('auth-email');
            const authPassword = document.getElementById('auth-password');
            const authCancel = document.getElementById('auth-cancel');
            const authSubmit = document.getElementById('auth-submit');

            // Full-page login elements (separate UI shown when user is not authenticated)
            const fullLoginPage = document.getElementById('full-login-page');
            const appRoot = document.getElementById('app-root');
            const fullEmail = document.getElementById('full-email');
            const fullPassword = document.getElementById('full-password');
            const fullLoginSubmit = document.getElementById('full-login-submit');
            const fullRegisterBtn = document.getElementById('full-register-btn');
            const fullForgotBtn = document.getElementById('full-forgot-btn');
            const fullLoginMsg = document.getElementById('full-login-msg');

            let authMode = 'login'; // or 'register'

            const openAuthModal = (mode) => {
                authMode = mode;
                authTitle.textContent = mode === 'login' ? 'Login' : 'Register';
                // adjust submit button label for clarity
                if (authSubmit) authSubmit.textContent = mode === 'login' ? 'Login' : 'Register';
                authEmail.value = '';
                authPassword.value = '';
                authModal.classList.remove('hidden');
                // focus the email input for convenience
                try { if (authEmail) { setTimeout(() => authEmail.focus(), 50); } } catch (e) {}
            };

            const closeAuthModal = () => { authModal.classList.add('hidden'); };

            if (loginBtn) loginBtn.addEventListener('click', () => openAuthModal('login'));
            if (registerBtn) registerBtn.addEventListener('click', () => openAuthModal('register'));
            if (authCancel) authCancel.addEventListener('click', closeAuthModal);

            if (authSubmit) authSubmit.addEventListener('click', async () => {
                if (isAuthCooldown()) { showToast('Too many failed attempts. Please wait before trying again.','error',4000); return; }
                const email = authEmail.value.trim();
                const password = authPassword.value;
                if (!email || !password) { showToast('Enter email and password', 'error'); return; }
                const origText = authSubmit.textContent;
                try {
                    injectSpinner(authSubmit);
                    if (authMode === 'register') {
                        const cred = await createUserWithEmailAndPassword(auth, email, password);
                        // create initial user documents in Firestore under /users/{uid}/...
                        try {
                            const uid = cred.user.uid;
                            console.log('User registered uid=', uid, 'creating initial docs...');
                            // user meta/profile
                            await setDoc(doc(db, 'users', uid, 'meta', 'profile'), { email, createdAt: serverTimestamp() });
                            // default categories (use current in-memory categories)
                            await setDoc(getCategoriesDoc(uid), categories);
                            console.log('Initial user docs created for uid=', uid);
                        } catch (docErr) {
                            console.error('Failed to create initial user documents: ', docErr);
                        }
                        try {
                            // send email verification
                            if (cred && cred.user && typeof sendEmailVerification === 'function') {
                                await sendEmailVerification(cred.user);
                                showToast('Registration successful. A confirmation email has been sent.', 'success', 6000);
                                // If registration originated from full-login page, show inline success
                                showFullLoginMessage('Registration successful. Check your email to confirm.', 'success');
                            } else {
                                showToast('Registration successful. Please verify your email.', 'success', 6000);
                                showFullLoginMessage('Registration successful. Please verify your email.', 'success');
                            }
                        } catch (verifyErr) {
                            console.error('Failed to send verification email: ', verifyErr);
                            showToast('Registered but failed to send confirmation email.', 'error');
                            showFullLoginMessage('Registered but failed to send confirmation email.', 'warn');
                        }
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                    closeAuthModal();
                } catch (err) {
                    console.error('Auth error: ', err);
                    recordAuthFailure();
                    const friendly = authErrorToMessage(err);
                    showToast(friendly, 'error', 5000);
                    // If the full-login page is visible (mobile), also show inline message
                    try { if (fullLoginPage && !fullLoginPage.classList.contains('hidden')) showFullLoginMessage(friendly, 'error'); } catch (e) {}
                    // If the error is user-not-found and user is on the auth modal, suggest registering
                    if (err && err.code === 'auth/user-not-found') {
                        // prefill email into register flow
                        if (authEmail && authEmail.value) {
                            openAuthModal('register');
                            authEmail.value = authEmail.value; // keep the email
                        }
                    }
                } finally {
                    try { removeSpinner(authSubmit); authSubmit.textContent = origText; } catch (e) {}
                }
            });

            // Full-page login button handlers
            if (fullLoginSubmit) fullLoginSubmit.addEventListener('click', async () => {
                if (isAuthCooldown()) { showToast('Too many failed attempts. Please wait before trying again.','error',4000); return; }
                const email = fullEmail && fullEmail.value ? fullEmail.value.trim() : '';
                const password = fullPassword && fullPassword.value ? fullPassword.value : '';
                if (!email || !password) { showToast('Enter email and password','error'); return; }
                try {
                    injectSpinner(fullLoginSubmit);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    console.error('Full-login sign in failed: ', err);
                    recordAuthFailure();
                    const friendly = authErrorToMessage(err);
                    // On full-login page show inline message for better UX on mobile
                    showFullLoginMessage(friendly, 'error');
                    showToast(friendly, 'error', 4000);
                    // If user not found, offer quick register link
                    if (err && err.code === 'auth/user-not-found') {
                        // show a subtle register suggestion next to message
                        setTimeout(() => {
                            // open register modal prefilled
                            openAuthModal('register');
                            if (fullEmail && authEmail) authEmail.value = fullEmail.value.trim();
                        }, 800);
                    }
                } finally {
                    try { removeSpinner(fullLoginSubmit); } catch (e) {}
                }
            });

            // submit on Enter key for convenience
            if (fullEmail) fullEmail.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); if (fullLoginSubmit) fullLoginSubmit.click(); } });
            if (fullPassword) fullPassword.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); if (fullLoginSubmit) fullLoginSubmit.click(); } });

            if (fullRegisterBtn) fullRegisterBtn.addEventListener('click', () => {
                // open register modal and prefill email if present
                const e = fullEmail && fullEmail.value ? fullEmail.value.trim() : '';
                openAuthModal('register');
                if (e && authEmail) authEmail.value = e;
            });

            if (fullForgotBtn) fullForgotBtn.addEventListener('click', () => {
                // hide full-login and open forgot-email modal
                if (fullLoginPage) fullLoginPage.classList.add('hidden');
                if (authModal) authModal.classList.add('hidden');
                if (forgotEmailModal) {
                    forgotEmailModal.classList.remove('hidden');
                    if (forgotEmailInput) {
                        // prefill with email if present
                        const e = fullEmail && fullEmail.value ? fullEmail.value.trim() : '';
                        if (e) forgotEmailInput.value = e;
                        try { forgotEmailInput.focus(); } catch (er) {}
                    }
                }
            });

            if (logoutBtn) logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch (e) { /* ignore */ } });
            const logoutBtnMobile = document.getElementById('logout-btn-mobile');
            if (logoutBtnMobile) logoutBtnMobile.addEventListener('click', async () => { try { await signOut(auth); } catch (e) { /* ignore */ } });

            // user menu interactions
            const userMenuBtn = document.getElementById('user-menu-btn');
            const userMenu = document.getElementById('user-menu');
            const userMenuEmail = document.getElementById('user-menu-email');
            const userMenuLogout = document.getElementById('user-menu-logout');
            if (userMenuBtn && userMenu) {
                userMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userMenu.classList.toggle('hidden');
                });
                document.addEventListener('click', (e) => { if (!userMenu.classList.contains('hidden')) userMenu.classList.add('hidden'); });
            }
            if (userMenuLogout) userMenuLogout.addEventListener('click', async () => { try { await signOut(auth); } catch (e) { /* ignore */ } });
            const forgotLink = document.getElementById('forgot-password-link');
            const forgotEmailModal = document.getElementById('forgot-email-modal');
            const forgotEmailInput = document.getElementById('forgot-email-input');
            const forgotEmailCancel = document.getElementById('forgot-email-cancel');
            const forgotEmailSend = document.getElementById('forgot-email-send');

            if (forgotLink) forgotLink.addEventListener('click', async (e) => {
                e.preventDefault();
                const email = (authEmail && authEmail.value) ? authEmail.value.trim() : '';
                if (!email) {
                    // if user didn't type email in login form, open modal to ask for it
                    // hide the auth modal so it doesn't overlap
                    if (authModal) authModal.classList.add('hidden');
                    if (forgotEmailModal) {
                        forgotEmailModal.classList.remove('hidden');
                        if (forgotEmailInput) try { forgotEmailInput.focus(); } catch (er) {}
                    }
                    return;
                }
                try {
                    await sendPasswordResetEmail(auth, email);
                    const msg = 'Password reset email sent. Check your inbox.';
                    showToast(msg,'success',4000);
                    try { if (fullLoginPage && !fullLoginPage.classList.contains('hidden')) showFullLoginMessage(msg, 'success'); } catch (e) {}
                    if (authModal) authModal.classList.add('hidden');
                } catch (err) {
                    console.error('Failed to send reset email: ', err);
                    recordAuthFailure();
                    const friendly = authErrorToMessage(err);
                    showToast('Failed to send reset email: ' + friendly,'error',5000);
                    try { if (fullLoginPage && !fullLoginPage.classList.contains('hidden')) showFullLoginMessage(friendly, 'error'); } catch (e) {}
                }
            });

            if (forgotEmailCancel) forgotEmailCancel.addEventListener('click', () => {
                if (forgotEmailModal) forgotEmailModal.classList.add('hidden');
                // re-open auth modal so user can continue signing in
                if (authModal) authModal.classList.remove('hidden');
            });
            if (forgotEmailSend) forgotEmailSend.addEventListener('click', async () => {
                const email = (forgotEmailInput && forgotEmailInput.value) ? forgotEmailInput.value.trim() : '';
                if (!email) return showToast('Enter an email address.','error');
                try {
                    await sendPasswordResetEmail(auth, email);
                    const msg = 'Password reset email sent. Check your inbox.';
                    showToast(msg,'success',4000);
                    try { if (fullLoginPage && !fullLoginPage.classList.contains('hidden')) showFullLoginMessage(msg, 'success'); } catch (e) {}
                    if (forgotEmailModal) forgotEmailModal.classList.add('hidden');
                    if (authModal) authModal.classList.add('hidden');
                } catch (err) {
                    console.error('Failed to send reset email from forgot-email modal: ', err);
                    recordAuthFailure();
                    const friendly = authErrorToMessage(err);
                    showToast('Failed to send reset email: ' + friendly,'error',5000);
                    try { if (fullLoginPage && !fullLoginPage.classList.contains('hidden')) showFullLoginMessage(friendly, 'error'); } catch (e) {}
                }
            });

            const userMenuChangeBtn = document.getElementById('user-menu-change-pw');
            const changePwModal = document.getElementById('change-password-modal');
            const changePwCancel = document.getElementById('change-pw-cancel');
            const changePwSubmit = document.getElementById('change-pw-submit');
            if (userMenuChangeBtn) userMenuChangeBtn.addEventListener('click', () => {
                if (!currentUser) return showToast('You must be signed in to change password.', 'warn');
                if (changePwModal) changePwModal.classList.remove('hidden');
                userMenu.classList.add('hidden');
            });
            if (changePwCancel) changePwCancel.addEventListener('click', () => { if (changePwModal) changePwModal.classList.add('hidden'); });
            if (changePwSubmit) changePwSubmit.addEventListener('click', async () => {
                const cur = document.getElementById('current-password').value;
                const nw = document.getElementById('new-password').value;
                if (!cur || !nw) return showToast('Enter current and new password.','error');
                if (nw.length < 6) return showToast('New password must be at least 6 characters.','error');
                try {
                    if (!currentUser) throw new Error('Not authenticated');
                    const cred = EmailAuthProvider.credential(currentUser.email, cur);
                    await reauthenticateWithCredential(currentUser, cred);
                    await updatePassword(currentUser, nw);
                    showToast('Password changed successfully.','success',4000);
                    if (changePwModal) changePwModal.classList.add('hidden');
                } catch (err) {
                    console.error('Change password failed: ', err);
                    recordAuthFailure();
                    showToast('Failed to change password: ' + (err && err.message ? err.message : String(err)),'error',5000);
                }
            });

            // TestWrite removed

            // debounce clearing state on transient null auth events (register/signin may emit intermediate null)
            let _authClearTimer = null;
            onAuthStateChanged(auth, (user) => {
                // cancel any pending clear when a user appears
                if (user) {
                    if (_authClearTimer) { clearTimeout(_authClearTimer); _authClearTimer = null; }
                }

                currentUser = user || null;
                console.log('Auth state changed. user=', currentUser ? currentUser.uid : null);
                if (user) {
                    if (userEmailSpan) {
                        const emailText = user.email || user.displayName || 'User';
                        userEmailSpan.textContent = emailText;
                        userEmailSpan.title = emailText;
                    }
                    if (userMenuEmail) userMenuEmail.textContent = user.email || user.displayName || 'User';
                    if (userInfo) userInfo.classList.remove('hidden');
                    if (loginBtn) loginBtn.classList.add('hidden');
                    if (registerBtn) registerBtn.classList.add('hidden');
                    // hide full-login and show app
                    if (fullLoginPage) fullLoginPage.classList.add('hidden');
                    if (appRoot) appRoot.classList.remove('hidden');
                    // subscribe to user-scoped data
                    try { subscribeCategoriesForUser(user.uid); } catch (e) { console.error('subscribeCategoriesForUser failed: ', e); }
                    try { subscribeTransactionsForUser(user.uid); } catch (e) { console.error('subscribeTransactionsForUser failed: ', e); }
                    try { loadBudgetsForMonth(); } catch (e) { console.error('loadBudgetsForMonth failed: ', e); }
                } else {
                    // delay clearing state briefly to avoid wiping during transient auth flips
                    // show full-login (app hidden)
                    if (fullLoginPage) {
                        fullLoginPage.classList.remove('hidden');
                        try { setTimeout(() => { if (fullEmail) fullEmail.focus(); }, 50); } catch (e) {}
                    }
                    if (appRoot) appRoot.classList.add('hidden');
                    if (_authClearTimer) { clearTimeout(_authClearTimer); }
                    _authClearTimer = setTimeout(() => {
                        _authClearTimer = null;
                        // cleanup subscriptions
                        if (categoriesUnsub) { try { categoriesUnsub(); } catch (e) {} categoriesUnsub = null; }
                        if (transactionsUnsub) { try { transactionsUnsub(); } catch (e) {} transactionsUnsub = null; }
                        if (budgetsUnsub) { try { budgetsUnsub(); } catch (e) {} budgetsUnsub = null; }
                        // reset local state
                        allTransactions = [];
                        budgets = {};
                        categories = { Income: ['Salary', 'Other Income'], Expense: ['Food & Drink','Transportation','Household Needs','Entertainment','Bills','Sports','Fashion','Other'] };
                        renderCategoriesPanel();
                        renderBudgetEditorForContainer(desktopFormContainer);
                        renderBudgetEditorForContainer(mobileFormContainer);
                        renderDashboard();
                        if (userInfo) userInfo.classList.add('hidden');
                        if (loginBtn) loginBtn.classList.remove('hidden');
                        if (registerBtn) registerBtn.classList.remove('hidden');
                    }, 800);
                }
            });

            const init = () => {
                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));

                const savedVisibility = localStorage.getItem('visibilityState');
                if (savedVisibility) {
                    visibilityState = JSON.parse(savedVisibility);
                } else {
                    visibilityState = { income: false, balance: false };
                }
                updateVisibilityUI();

                try { populateYearSelect(); } catch (e) {}
                populateMonthFilter();
                scheduleWIBMonthAutoSwitch();

                populateAccountOptions(desktopFormContainer, accounts);
                populateAccountOptions(mobileFormContainer, accounts);
                
                // load budgets for the currently selected month from localStorage
                loadBudgetsForMonth();

                // categories are user-scoped; subscription established on auth
                subscribeCategoriesForUser = (uid) => {
                    if (categoriesUnsub) { try { categoriesUnsub(); } catch (e) {} categoriesUnsub = null; }
                    const ref = getCategoriesDoc(uid);
                    categoriesUnsub = onSnapshot(ref, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            // normalize shape
                            categories = {
                                Income: Array.isArray(data.Income) ? data.Income.slice() : (data.Income ? Object.values(data.Income) : ['Salary','Other Income']),
                                Expense: Array.isArray(data.Expense) ? data.Expense.slice() : (data.Expense ? Object.values(data.Expense) : ['Food & Drink','Transportation','Household Needs','Entertainment','Bills','Sports','Fashion','Other'])
                            };
                        } else {
                            // initialize default categories in Firestore if missing
                            setDoc(ref, categories).catch(err => console.error('Failed to initialize categories: ', err));
                        }
                        renderCategoriesPanel();
                        renderBudgetEditorForContainer(desktopFormContainer);
                        renderBudgetEditorForContainer(mobileFormContainer);
                        renderDashboard();
                    }, (err) => {
                        console.error('Error loading categories: ', err);
                        renderCategoriesPanel();
                    });
                };

                resetFormState();
                desktopTbody.innerHTML = '<tr><td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">Loading data from cloud...</td></tr>';
                mobileCardList.innerHTML = '<div class="text-center py-10 text-gray-500 dark:text-gray-400">Loading data from cloud...</div>';

                subscribeTransactionsForUser = async (uid) => {
                    if (transactionsUnsub) { try { transactionsUnsub(); } catch (e) {} transactionsUnsub = null; }
                    const ref = getTransactionsCol(uid);
                    // initial server read to diagnose read permissions / existing docs
                    try {
                        const snap = await getDocs(ref);
                        console.log('Initial getDocs for transactions, size=', snap.size, 'ids=', snap.docs.map(d=>d.id));
                        // map to local state immediately with diagnostics and Timestamp handling
                        const initialDocs = snap.docs.map(d => ({ id: d.id, path: d.ref.path, data: d.data() }));
                        console.log('Initial transaction docs detail:', initialDocs.map(d => ({ id: d.id, path: d.path, dateType: d.data && d.data.date ? (typeof d.data.date) : 'missing', dateValue: d.data && d.data.date ? d.data.date : null })));
                        setAllTransactionsFromRaw(initialDocs);
                        try { populateYearSelect(); } catch (e) {}
                        populateMonthFilter();
                        renderDashboard();
                    } catch (err) {
                        console.error('Initial getDocs failed for transactions: ', err, 'ref.path=', ref && ref.path, 'clientProject=', (app && app.options && app.options.projectId));
                    }

                    // then attach realtime listener
                    transactionsUnsub = onSnapshot(ref, (snapshot) => {
                        console.log('Transactions snapshot received, size=', snapshot.size, 'ids=', snapshot.docs.map(d=>d.id));
                        const docsDetail = snapshot.docs.map(d => ({ id: d.id, path: d.ref.path, data: d.data() }));
                        console.log('Snapshot transaction docs detail:', docsDetail.map(d => ({ id: d.id, path: d.path, dateType: d.data && d.data.date ? (typeof d.data.date) : 'missing', dateValue: d.data && d.data.date ? d.data.date : null })));
                        setAllTransactionsFromRaw(docsDetail);
                        try { populateYearSelect(); } catch (e) {}
                        populateMonthFilter();
                        renderDashboard();
                        try { updateTrendAnalysisCards(allTransactions); } catch (e) { /* safe */ }
                        try {
                            const monthFilterEl = document.getElementById('month-filter');
                            const endKey = monthFilterEl ? monthFilterEl.value : undefined;
                            if (btnTrend && btnTrend.classList.contains('filter-btn-active')) {
                                renderTrendChart(allTransactions, parseInt(trendRange.value || '6', 10), endKey);
                            }
                        } catch (e) { /* ignore */ }
                    }, (error) => {
                        console.error("Error fetching transactions (onSnapshot): ", error, 'ref.path=', ref && ref.path, 'clientProject=', (app && app.options && app.options.projectId));
                        const errorMessage = 'Failed to load data. Please check your internet connection or Firestore rules.';
                        desktopTbody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-red-500">${errorMessage}</td></tr>`;
                        mobileCardList.innerHTML = `<div class="text-center py-10 text-red-500">${errorMessage}</div>`;
                    });
                };

                // wire category UI toggles after DOM ready
                try { wireCategoryToggles(); } catch (e) { /* ignore if not defined */ }

                // --- Trend analysis helpers ---
                function formatCurrencyAmount(v) {
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(v);
                }

                function getYearKey(d) { return d.getFullYear(); }

                function updateTrendAnalysisCards(transactions) {
                    if (!Array.isArray(transactions)) return;
                    // analysis area visibility is controlled by the tab toggle
                    const analysisWrapper = document.getElementById('trend-analysis-cards');

                    const now = new Date();
                    const currentYear = now.getFullYear();

                    // Filter expense transactions for current year
                    const expensesThisYear = transactions.filter(t => {
                        const d = new Date(t.date);
                        return (t.type && t.type.toLowerCase() === 'expense') && d.getFullYear() === currentYear;
                    });

                    // Aggregate by category
                    const categorySums = {};
                    let totalThisYear = 0;
                    expensesThisYear.forEach(t => {
                        const amt = Math.abs(Number(t.amount) || 0);
                        const cat = t.category || 'Other';
                        categorySums[cat] = (categorySums[cat] || 0) + amt;
                        totalThisYear += amt;
                    });

                    // Top 3 categories
                    const topCats = Object.entries(categorySums).sort((a,b) => b[1]-a[1]).slice(0,3);
                    const topList = document.getElementById('top-categories-list');
                    if (topList) {
                        topList.innerHTML = '';
                        topCats.forEach(([cat, sum]) => {
                            const pct = totalThisYear > 0 ? Math.round((sum/totalThisYear)*100) : 0;
                            const item = document.createElement('div');
                            item.className = 'flex flex-col';
                            item.innerHTML = `
                                <div class="flex justify-between items-center text-sm">
                                    <div class="font-medium text-gray-700 dark:text-gray-200">${cat}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-300">${formatCurrencyAmount(sum)}</div>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded mt-1 overflow-hidden">
                                    <div class="bg-blue-600 h-2 rounded" style="width: ${pct}%;"></div>
                                </div>
                            `;
                            topList.appendChild(item);
                        });
                        if (topCats.length === 0) topList.innerHTML = '<div class="text-sm text-gray-500">No expense data for this year.</div>';
                    }

                    // Monthly comparison: this month vs last month (expenses only)
                    const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    function monthKey(d) { return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`; }
                    const thisKey = monthKey(thisMonth);
                    const lastKey = monthKey(lastMonth);

                    const sumsByMonth = {};
                    transactions.forEach(t => {
                        if (!t.date) return;
                        const d = new Date(t.date);
                        const key = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
                        if (!sumsByMonth[key]) sumsByMonth[key] = 0;
                        if (t.type && t.type.toLowerCase() === 'expense') sumsByMonth[key] += Math.abs(Number(t.amount) || 0);
                    });

                    const thisTotal = sumsByMonth[thisKey] || 0;
                    const lastTotal = sumsByMonth[lastKey] || 0;

                    const thisEl = document.getElementById('this-month-total');
                    const lastEl = document.getElementById('last-month-total');
                    const changeEl = document.getElementById('month-change');
                    if (thisEl) thisEl.textContent = formatCurrencyAmount(thisTotal);
                    if (lastEl) lastEl.textContent = formatCurrencyAmount(lastTotal);
                    if (changeEl) {
                        let pct = 0;
                        let label = '';
                        if (lastTotal === 0 && thisTotal === 0) {
                            label = 'No change';
                            changeEl.className = 'font-semibold text-gray-600 dark:text-gray-300';
                        } else if (lastTotal === 0) {
                            label = ` ${Math.round(100)}% more than last month`;
                            changeEl.className = 'font-semibold text-red-600';
                        } else {
                            pct = Math.round(((thisTotal - lastTotal) / lastTotal) * 100);
                            if (pct > 0) { label = ` ${pct}% more than last month`; changeEl.className = 'font-semibold text-red-600'; }
                            else if (pct < 0) { label = ` ${Math.abs(pct)}% less than last month`; changeEl.className = 'font-semibold text-green-600'; }
                            else { label = 'No change'; changeEl.className = 'font-semibold text-gray-600 dark:text-gray-300'; }
                        }
                        changeEl.textContent = label;
                    }
                }

                // close categories panels and budget editors when clicking outside
                document.addEventListener('click', (e) => {
                    // if click inside any categories-panel or on any toggle or inside budget-editor or on any budget toggle, ignore
                    if (e.target.closest('.categories-panel') || e.target.closest('.manage-categories-toggle') || e.target.closest('.budget-editor') || e.target.closest('.toggle-budget-editor')) return;
                    document.querySelectorAll('.categories-panel').forEach(p => p.classList.add('hidden'));
                    document.querySelectorAll('.budget-editor').forEach(b => b.classList.add('hidden'));
                });
            };

            init();
        });
    </script>
</body>
</html>